---
phase: 02.1-security-privacy-hardening
plan: 03
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - src/stores/employeeStore.ts
  - src/stores/officeStore.ts
  - src/types/employee.ts
  - src/types/office.ts
  - src/services/validationService.ts
autonomous: true

must_haves:
  truths:
    - "Employee and office stores use encrypted storage adapter"
    - "Employee type includes postcode field and geocodeAccuracy"
    - "Office type includes postcode field"
    - "Validation schemas require 5-digit postcode"
  artifacts:
    - path: "src/stores/employeeStore.ts"
      provides: "Employee store with encrypted persist"
      contains: "encryptedStorage"
    - path: "src/stores/officeStore.ts"
      provides: "Office store with encrypted persist"
      contains: "encryptedStorage"
    - path: "src/types/employee.ts"
      provides: "Employee type with postcode and accuracy"
      contains: "postcode"
    - path: "src/types/office.ts"
      provides: "Office type with postcode"
      contains: "postcode"
    - path: "src/services/validationService.ts"
      provides: "Updated schemas with postcode validation"
      contains: "regex.*\\d{5}"
  key_links:
    - from: "src/stores/employeeStore.ts"
      to: "src/services/encryptedStorage.ts"
      via: "storage option in persist"
      pattern: "storage:\\s*encryptedStorage"
    - from: "src/stores/officeStore.ts"
      to: "src/services/encryptedStorage.ts"
      via: "storage option in persist"
      pattern: "storage:\\s*encryptedStorage"
---

<objective>
Integrate encrypted storage into Zustand stores and update types/schemas to require postcode instead of full address.

Purpose: Protect data at rest with encryption and prepare the data model for local geocoding (postcode-based).
Output: Encrypted stores, updated Employee/Office types with postcode, updated validation schemas
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-security-privacy-hardening/02.1-RESEARCH.md
@.planning/phases/02.1-security-privacy-hardening/02.1-01-SUMMARY.md
@src/stores/employeeStore.ts
@src/stores/officeStore.ts
@src/types/employee.ts
@src/types/office.ts
@src/services/validationService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update stores to use encrypted storage</name>
  <files>
    src/stores/employeeStore.ts
    src/stores/officeStore.ts
  </files>
  <action>
Update both stores to use the encrypted storage adapter from Plan 01.

1. In `src/stores/employeeStore.ts`:
   - Add import: `import { encryptedStorage } from '../services/encryptedStorage';`
   - Update persist options to use custom storage:
   ```typescript
   persist(
     (set) => ({
       // ... existing state and actions
     }),
     {
       name: 'employee-storage',
       storage: encryptedStorage,
     }
   )
   ```

2. In `src/stores/officeStore.ts`:
   - Add import: `import { encryptedStorage } from '../services/encryptedStorage';`
   - Update persist options to use custom storage:
   ```typescript
   persist(
     (set) => ({
       // ... existing state and actions
     }),
     {
       name: 'office-storage',
       storage: encryptedStorage,
     }
   )
   ```

Keep all existing state properties and actions unchanged. Only the storage mechanism changes.
  </action>
  <verify>
    - `grep "encryptedStorage" src/stores/employeeStore.ts` confirms import and usage
    - `grep "encryptedStorage" src/stores/officeStore.ts` confirms import and usage
    - `npm run build` succeeds
  </verify>
  <done>
    Both stores persist to encrypted localStorage, data protected at rest
  </done>
</task>

<task type="auto">
  <name>Task 2: Update types and validation for postcode-based geocoding</name>
  <files>
    src/types/employee.ts
    src/types/office.ts
    src/services/validationService.ts
  </files>
  <action>
1. Update `src/types/employee.ts`:
```typescript
export interface Employee {
  id: string;
  name: string;
  postcode: string;           // Required for local geocoding (5-digit German)
  street?: string;            // Optional, for display and accurate mode
  city?: string;              // Auto-filled from postcode lookup or CSV
  team: string;
  department?: string;
  role?: string;
  assignedOffice?: string;
  coords?: { lat: number; lon: number };
  geocodeAccuracy: 'postcode-centroid' | 'address';
  geocodeStatus: 'pending' | 'success' | 'failed';
}
```

2. Update `src/types/office.ts`:
```typescript
export interface Office {
  id: string;
  name: string;
  postcode: string;           // Required for local geocoding
  street?: string;            // Optional, for display
  city?: string;              // Auto-filled from postcode lookup or CSV
  coords?: { lat: number; lon: number };
  geocodeStatus: 'pending' | 'success' | 'failed';
}
```

3. Update `src/services/validationService.ts` schemas:
```typescript
export const OfficeSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  postcode: z.string().regex(/^\d{5}$/, 'German postcode must be 5 digits'),
  street: z.string().optional(),
  city: z.string().optional(),
});

export const EmployeeSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  postcode: z.string().regex(/^\d{5}$/, 'German postcode must be 5 digits'),
  team: z.string().min(1, 'Team is required'),
  street: z.string().optional(),
  city: z.string().optional(),
  department: z.string().optional(),
  role: z.string().optional(),
  assignedOffice: z.string().optional(),
});
```

Note: Remove the old `address` field from schemas. The CSV should now have `postcode` column instead.

Update the derived types:
```typescript
export type ValidatedOffice = z.infer<typeof OfficeSchema>;
export type ValidatedEmployee = z.infer<typeof EmployeeSchema>;
```
  </action>
  <verify>
    - `grep "postcode:" src/types/employee.ts` confirms new field
    - `grep "geocodeAccuracy" src/types/employee.ts` confirms accuracy field
    - `grep "postcode:" src/types/office.ts` confirms new field
    - `grep "regex.*\\\\d{5}" src/services/validationService.ts` confirms postcode validation
    - `npm run build` succeeds (may have errors in other files that import these - expected, will fix in Plan 04)
  </verify>
  <done>
    Types and schemas updated for postcode-based geocoding with accuracy tracking
  </done>
</task>

</tasks>

<verification>
1. `npm run build` - may show errors in files that use old Employee/Office types (expected)
2. localStorage data will be encrypted after stores are used
3. Validation requires 5-digit postcode
4. Employee type has geocodeAccuracy field
</verification>

<success_criteria>
- Stores use encryptedStorage adapter
- Employee type has postcode (required), street/city (optional), geocodeAccuracy
- Office type has postcode (required), street/city (optional)
- Validation schemas require 5-digit German postcode
- Build may fail on dependent files (to be fixed in Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-security-privacy-hardening/02.1-03-SUMMARY.md`
</output>
