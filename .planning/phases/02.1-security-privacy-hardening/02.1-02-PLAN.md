---
phase: 02.1-security-privacy-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/germanPostcodes.ts
  - src/services/localGeocodingService.ts
autonomous: true

must_haves:
  truths:
    - "Bundled postcode data covers German postcodes with lat/lon centroids"
    - "Local geocoding returns coordinates synchronously without network"
    - "Unknown postcodes return null coords (not throw)"
  artifacts:
    - path: "src/data/germanPostcodes.ts"
      provides: "Bundled German postcode centroid data"
      exports: ["GERMAN_POSTCODES", "PostcodeEntry"]
      min_lines: 100
    - path: "src/services/localGeocodingService.ts"
      provides: "Synchronous postcode-to-coords lookup"
      exports: ["geocodeByPostcode", "LocalGeocodeResult"]
      min_lines: 20
  key_links:
    - from: "src/services/localGeocodingService.ts"
      to: "src/data/germanPostcodes.ts"
      via: "import GERMAN_POSTCODES"
      pattern: "GERMAN_POSTCODES\\[.*\\]"
---

<objective>
Bundle German postcode centroid data and create local geocoding service for zero-network address resolution.

Purpose: Enable geocoding without external API calls. This is the core privacy feature - all distance calculations work offline.
Output: germanPostcodes.ts data file (~8000 entries), localGeocodingService.ts for sync lookup
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-security-privacy-hardening/02.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download and bundle German postcode data</name>
  <files>
    src/data/germanPostcodes.ts
  </files>
  <action>
Create `src/data/germanPostcodes.ts` with bundled German postcode centroids.

Data source: WZB plz_geocoord dataset (Apache 2.0 license)
Repository: https://github.com/WZBSocialScienceCenter/plz_geocoord

The file should:
1. Define PostcodeEntry interface:
```typescript
export interface PostcodeEntry {
  lat: number;
  lon: number;
  place?: string;
}
```

2. Export GERMAN_POSTCODES as Record<string, PostcodeEntry>

3. Include all ~8,000 German postcodes with their centroid coordinates

To generate the data:
- Fetch from https://raw.githubusercontent.com/WZBSocialScienceCenter/plz_geocoord/master/plz_geocoord.csv
- Parse CSV: columns are plz,lat,lon
- Format as TypeScript object literal
- Add Apache 2.0 license comment header

Example structure:
```typescript
/**
 * German postcode centroid coordinates
 * Source: https://github.com/WZBSocialScienceCenter/plz_geocoord
 * License: Apache 2.0
 * Generated: 2026-02-07
 */

export interface PostcodeEntry {
  lat: number;
  lon: number;
  place?: string;
}

export const GERMAN_POSTCODES: Record<string, PostcodeEntry> = {
  "01067": { lat: 51.0575, lon: 13.7171 },
  "01069": { lat: 51.0409, lon: 13.7399 },
  // ... ~8,000 entries
};
```

Use a script to fetch and convert:
```bash
curl -s https://raw.githubusercontent.com/WZBSocialScienceCenter/plz_geocoord/master/plz_geocoord.csv | \
  tail -n +2 | \
  awk -F',' '{printf "  \"%s\": { lat: %s, lon: %s },\n", $1, $2, $3}'
```

Wrap output in TypeScript file structure.
  </action>
  <verify>
    - File exists at src/data/germanPostcodes.ts
    - `grep "01067" src/data/germanPostcodes.ts` finds Berlin entry
    - `grep "80331" src/data/germanPostcodes.ts` finds Munich entry
    - `npm run build` succeeds (valid TypeScript)
  </verify>
  <done>
    GERMAN_POSTCODES contains ~8,000 German postcode centroids, properly typed
  </done>
</task>

<task type="auto">
  <name>Task 2: Create local geocoding service</name>
  <files>
    src/services/localGeocodingService.ts
  </files>
  <action>
Create `src/services/localGeocodingService.ts` with synchronous postcode lookup:

```typescript
import { GERMAN_POSTCODES } from '../data/germanPostcodes';

export interface LocalGeocodeResult {
  postcode: string;
  coords: { lat: number; lon: number } | null;
  city: string | null;
  accuracy: 'postcode-centroid';
}

/**
 * Geocode using bundled postcode data - NO external requests.
 * Returns centroid coordinates for the postcode area (~5km accuracy).
 */
export function geocodeByPostcode(postcode: string): LocalGeocodeResult {
  // Normalize: remove spaces, ensure 5 digits
  const normalized = postcode.trim().replace(/\s/g, '');
  const data = GERMAN_POSTCODES[normalized];

  return {
    postcode: normalized,
    coords: data ? { lat: data.lat, lon: data.lon } : null,
    city: data?.place ?? null,
    accuracy: 'postcode-centroid',
  };
}

/**
 * Batch geocode multiple postcodes - all synchronous, no network.
 */
export function batchGeocodeByPostcode(postcodes: string[]): LocalGeocodeResult[] {
  return postcodes.map(geocodeByPostcode);
}

/**
 * Check if a postcode exists in the bundled data.
 */
export function isValidPostcode(postcode: string): boolean {
  const normalized = postcode.trim().replace(/\s/g, '');
  return normalized in GERMAN_POSTCODES;
}
```

Key behaviors:
- Synchronous (no async/await needed)
- Returns null coords for unknown postcodes (graceful failure)
- Normalizes input (trims whitespace, removes spaces within)
- Always returns 'postcode-centroid' accuracy
  </action>
  <verify>
    - File exists at src/services/localGeocodingService.ts
    - `grep "geocodeByPostcode" src/services/localGeocodingService.ts` confirms export
    - `npm run build` succeeds
  </verify>
  <done>
    Local geocoding service ready for use, returns coords synchronously from bundled data
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. germanPostcodes.ts file is >100KB (contains ~8000 entries)
3. Both files have correct TypeScript types
4. No network dependencies in localGeocodingService.ts
</verification>

<success_criteria>
- GERMAN_POSTCODES exported with ~8000 German postcode centroids
- geocodeByPostcode returns coordinates synchronously
- Unknown postcodes return null coords (no throw)
- License attribution present in germanPostcodes.ts
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-security-privacy-hardening/02.1-02-SUMMARY.md`
</output>
