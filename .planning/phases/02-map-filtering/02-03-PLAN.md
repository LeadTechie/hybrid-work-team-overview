---
phase: 02-map-filtering
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/hooks/useFilteredEmployees.ts
  - src/components/filters/FilterPanel.tsx
  - src/components/filters/EmployeeSearch.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter employees by team using dropdown"
    - "User can filter employees by department using dropdown"
    - "User can filter employees by assigned office using dropdown"
    - "User can search for employee by name with autocomplete suggestions"
    - "User can change color-coding mode between team/department/office"
    - "User can clear all filters with one click"
  artifacts:
    - path: "src/hooks/useFilteredEmployees.ts"
      provides: "Memoized filtered employee list"
      exports: ["useFilteredEmployees"]
    - path: "src/components/filters/FilterPanel.tsx"
      provides: "Filter dropdowns and color-by selector"
      exports: ["FilterPanel"]
    - path: "src/components/filters/EmployeeSearch.tsx"
      provides: "Debounced name search with suggestions"
      exports: ["EmployeeSearch"]
  key_links:
    - from: "src/hooks/useFilteredEmployees.ts"
      to: "src/stores/filterStore.ts"
      via: "reads filter state"
      pattern: "useFilterStore"
    - from: "src/hooks/useFilteredEmployees.ts"
      to: "src/stores/employeeStore.ts"
      via: "reads employee data"
      pattern: "useEmployeeStore"
    - from: "src/components/filters/EmployeeSearch.tsx"
      to: "use-debounce"
      via: "debounced search callback"
      pattern: "useDebouncedCallback"
---

<objective>
Create the filtering infrastructure and UI components for employee filtering and search.

Purpose: Implements the derived data selector and filter controls that allow users to narrow down which employees appear on the map and search for specific individuals.

Output:
- useFilteredEmployees.ts: Memoized hook that returns employees matching current filters
- FilterPanel.tsx: Dropdowns for team/department/office filtering and color-by selection
- EmployeeSearch.tsx: Search input with debounce and autocomplete suggestions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-map-filtering/02-RESEARCH.md

@src/stores/filterStore.ts
@src/stores/employeeStore.ts
@src/stores/officeStore.ts
@src/types/employee.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useFilteredEmployees hook</name>
  <files>src/hooks/useFilteredEmployees.ts</files>
  <action>
Create src/hooks/ directory and useFilteredEmployees.ts following research Pattern 3.

Hook logic:
1. Get employees from useEmployeeStore((s) => s.employees)
2. Get filter state from useFilterStore: teamFilter, departmentFilter, officeFilter, searchQuery
3. Return useMemo that filters employees:
   - Filter out employees without coords (geocodeStatus !== 'success')
   - If teamFilter set, filter by emp.team === teamFilter
   - If departmentFilter set, filter by emp.department === departmentFilter
   - If officeFilter set, filter by emp.assignedOffice === officeFilter
   - If searchQuery set (length > 0), filter by emp.name.toLowerCase().includes(searchQuery.toLowerCase())
4. Dependencies: [employees, teamFilter, departmentFilter, officeFilter, searchQuery]

Return type: Employee[] (filtered)

Export as named export: useFilteredEmployees
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/hooks/useFilteredEmployees.ts`</verify>
  <done>Hook returns correctly filtered employee list based on all active filters</done>
</task>

<task type="auto">
  <name>Task 2: Create FilterPanel component</name>
  <files>src/components/filters/FilterPanel.tsx</files>
  <action>
Create src/components/filters/ directory and FilterPanel.tsx following research code example.

Component structure:
1. Get employees from useEmployeeStore for deriving unique values
2. Get offices from useOfficeStore for office dropdown
3. Get filter state and setters from useFilterStore

Derive unique options using useMemo:
- teams: [...new Set(employees.map(e => e.team))].filter(Boolean).sort()
- departments: [...new Set(employees.map(e => e.department))].filter(Boolean).sort()

Render a container div with className="filter-panel" containing:

1. Color-by selector:
   - Label: "Color by:"
   - Select with id="color-by"
   - Options: "Team", "Department", "Assigned Office"
   - Values: "team", "department", "assignedOffice"
   - onChange calls setColorBy

2. Team filter:
   - Label: "Team:"
   - Select with id="team-filter"
   - First option: value="" text="All Teams"
   - Map teams to options
   - onChange calls setTeamFilter(value || null)

3. Department filter:
   - Label: "Department:"
   - Select with id="dept-filter"
   - First option: value="" text="All Departments"
   - Map departments to options
   - onChange calls setDepartmentFilter(value || null)

4. Office filter:
   - Label: "Office:"
   - Select with id="office-filter"
   - First option: value="" text="All Offices"
   - Map offices to options (use office.name for both value and display)
   - onChange calls setOfficeFilter(value || null)

5. Clear button:
   - Text: "Clear Filters"
   - onClick calls clearFilters

Use native select elements (not react-select per research recommendation).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/filters/FilterPanel.tsx`</verify>
  <done>FilterPanel renders all dropdowns and clear button, connected to filterStore</done>
</task>

<task type="auto">
  <name>Task 3: Create EmployeeSearch component with debounce</name>
  <files>src/components/filters/EmployeeSearch.tsx</files>
  <action>
Create EmployeeSearch.tsx following research code example with modifications.

Import useDebouncedCallback from 'use-debounce'.

Component state:
- inputValue: string (controlled input value)
- showSuggestions: boolean (whether to show dropdown)

Logic:
1. Get employees from useEmployeeStore
2. Get setSearchQuery, setSelectedEmployeeId from useFilterStore

3. Create debounced search:
```typescript
const debouncedSearch = useDebouncedCallback((value: string) => {
  setSearchQuery(value);
}, 250);
```

4. Create suggestions with useMemo:
- If inputValue.length < 2, return []
- Filter employees where name.toLowerCase().includes(inputValue.toLowerCase())
- Limit to first 5 results
- Dependencies: [inputValue, employees]

5. handleInputChange:
- Update inputValue
- Call debouncedSearch(value)
- setShowSuggestions(true)

6. handleSelect(employee):
- setInputValue(employee.name)
- setSearchQuery(employee.name)
- setSelectedEmployeeId(employee.id)
- setShowSuggestions(false)

7. handleClear:
- setInputValue('')
- setSearchQuery('')
- setSelectedEmployeeId(null)
- setShowSuggestions(false)

Render:
- Container div with className="employee-search" and position: relative style
- Text input with:
  - placeholder="Search employee by name..."
  - value={inputValue}
  - onChange={handleInputChange}
  - onFocus={() => setShowSuggestions(true)}
  - aria-label="Search employees"
- Clear button (x) shown when inputValue is non-empty
- Suggestions dropdown (ul) shown when showSuggestions && suggestions.length > 0:
  - Position absolute, below input
  - List items with button for each suggestion
  - Show employee.name and employee.team in button text
  - onClick calls handleSelect

Add onBlur handler with setTimeout to allow click on suggestion before hiding.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/filters/EmployeeSearch.tsx`</verify>
  <done>EmployeeSearch provides debounced search with autocomplete suggestions</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. useFilteredEmployees returns filtered array based on active filters
3. FilterPanel has all four dropdowns plus clear button
4. EmployeeSearch uses useDebouncedCallback with 250ms delay
5. EmployeeSearch shows up to 5 suggestions when typing
</verification>

<success_criteria>
- useFilteredEmployees correctly combines all filter criteria
- FilterPanel shows dynamically-derived options from actual employee data
- EmployeeSearch debounces input to prevent excessive filtering
- Selecting a suggestion sets the selectedEmployeeId for map flyTo
- Clear filters button resets all filters at once
</success_criteria>

<output>
After completion, create `.planning/phases/02-map-filtering/02-03-SUMMARY.md`
</output>
