---
phase: 01-foundation-data-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/components/import/ImportPanel.tsx
  - src/components/import/CsvUploader.tsx
  - src/components/import/PreviewTable.tsx
  - src/components/import/ImportProgress.tsx
  - src/components/DataSummary.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can paste CSV text into textarea"
    - "User can upload .csv file via drag-drop or file picker"
    - "Parsed data appears in preview table before import"
    - "Invalid rows shown with error messages in preview"
    - "User clicks confirm to finalize import"
    - "Geocoding progress bar shows X of Y during import"
    - "Data merges with existing (doesn't replace)"
    - "Summary shows office count, employee count, and geocode failures"
  artifacts:
    - path: "src/components/import/ImportPanel.tsx"
      provides: "Main import container"
      contains: "ImportPanel"
    - path: "src/components/import/CsvUploader.tsx"
      provides: "Paste + file upload"
      contains: "CsvUploader"
    - path: "src/components/import/PreviewTable.tsx"
      provides: "Data preview with errors"
      contains: "PreviewTable"
    - path: "src/components/import/ImportProgress.tsx"
      provides: "Geocoding progress bar"
      contains: "ImportProgress"
    - path: "src/components/DataSummary.tsx"
      provides: "Current data state display"
      contains: "DataSummary"
  key_links:
    - from: "src/components/import/ImportPanel.tsx"
      to: "src/services/csvService.ts"
      via: "CSV parsing"
      pattern: "import.*parseEmployeeCsv.*from"
    - from: "src/components/import/ImportPanel.tsx"
      to: "src/services/geocodingService.ts"
      via: "geocoding"
      pattern: "import.*batchGeocode.*from"
    - from: "src/components/import/ImportPanel.tsx"
      to: "src/stores/employeeStore.ts"
      via: "store update"
      pattern: "useEmployeeStore"
---

<objective>
Create the import UI that allows users to paste or upload CSV files, preview data before import, and see geocoding progress.

Purpose: Completes the data pipeline by providing user-facing interface for CSV import. Implements the preview-before-import and merge behavior per user decisions.
Output: Working import interface where users can import offices and employees via CSV, see preview with validation errors, and monitor geocoding progress.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-data-pipeline/01-CONTEXT.md
@.planning/phases/01-foundation-data-pipeline/01-RESEARCH.md
@.planning/phases/01-foundation-data-pipeline/01-01-SUMMARY.md
@.planning/phases/01-foundation-data-pipeline/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV uploader and preview components</name>
  <files>src/components/import/CsvUploader.tsx, src/components/import/PreviewTable.tsx</files>
  <action>
Create CsvUploader.tsx:
- Textarea for pasting CSV text
- File input for .csv upload (styled button + hidden input)
- Use react-dropzone for drag-drop support (install if not present: npm install react-dropzone)
- Accept only .csv and text/csv MIME types
- On file drop/select: read file content using FileReader
- On paste/file-read: call onChange callback with CSV text
- Show clear button to reset
- Simple styling with Tailwind (if available) or inline styles

Props:
```typescript
interface CsvUploaderProps {
  onCsvChange: (csvText: string) => void;
  placeholder?: string;
}
```

Create PreviewTable.tsx:
- Displays parsed CSV data in table format
- Shows first 10 rows + "and X more" if larger
- Highlights invalid rows with red background
- Shows error messages for invalid rows in a tooltip or inline
- Columns: dynamically generated from data keys
- Shows count: "X valid, Y invalid"

Props:
```typescript
interface PreviewTableProps {
  valid: Array<Record<string, unknown>>;
  invalid: Array<{ row: number; data: Record<string, unknown>; errors: string[] }>;
}
```

Styling: Clean, minimal per PROJECT.md constraints. Use basic CSS or Tailwind.
  </action>
  <verify>
Render CsvUploader and PreviewTable in App.tsx.
Paste CSV text - should trigger onChange.
Upload .csv file - should read content and trigger onChange.
Pass mock valid/invalid data to PreviewTable - should render correctly.
  </verify>
  <done>
CsvUploader handles paste and file upload. PreviewTable shows valid/invalid rows with error display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create import panel with geocoding integration</name>
  <files>src/components/import/ImportPanel.tsx, src/components/import/ImportProgress.tsx, src/components/DataSummary.tsx, src/App.tsx</files>
  <action>
Create ImportProgress.tsx:
- Shows progress bar during geocoding
- Display: "Geocoding: X of Y addresses"
- Show current address being processed
- Animate progress bar smoothly

Props:
```typescript
interface ImportProgressProps {
  completed: number;
  total: number;
  current: string;
}
```

Create ImportPanel.tsx - main import workflow container:
1. State: mode ('idle' | 'preview' | 'importing' | 'done')
2. State: csvText, parseResult, geocodingProgress, importResult

**Workflow per CONTEXT.md decisions:**

Step 1 - Upload/Paste (mode: 'idle'):
- Render CsvUploader
- Two tabs/buttons: "Import Offices" and "Import Employees"
- On CSV change: parse using appropriate service, set mode to 'preview'

Step 2 - Preview (mode: 'preview'):
- Render PreviewTable with parsed data
- Show summary: "X valid, Y invalid rows"
- If invalid rows: show warning but allow proceed
- Buttons: "Cancel" (reset), "Import X valid rows"
- On confirm: start geocoding, set mode to 'importing'

Step 3 - Importing (mode: 'importing'):
- Render ImportProgress
- Call batchGeocode with addresses from valid rows
- Update progress as callback fires
- On complete: merge results into store (addEmployees/addOffices)
- Set mode to 'done'

Step 4 - Done (mode: 'done'):
- Show summary: "Imported X records. Y geocoded successfully, Z failed."
- Button: "Import More" (reset to idle)

**Merge behavior per CONTEXT.md:**
- Use addEmployees/addOffices (not set) to merge with existing data

Create DataSummary.tsx:
- Shows current data state: "X offices, Y employees"
- Shows geocode status breakdown: "Z pending, W failed"
- Button: "Clear All Data" (calls clearOffices + clearEmployees)

Update App.tsx:
- Add ImportPanel component
- Add DataSummary component
- Layout: DataSummary at top, ImportPanel below
- Remove temporary test code from previous plans
  </action>
  <verify>
1. Load app - should show DataSummary with seed data count
2. Open import panel, select "Import Employees"
3. Paste CSV: `name,address,team\nTest User,Berlin Germany,TestTeam`
4. Preview shows parsed row
5. Click confirm - geocoding progress appears
6. After complete - new employee appears in DataSummary count
7. Import another - count increases (merge works)
8. Clear all data - count goes to 0
9. Refresh - seed data reloads if empty
  </verify>
  <done>
Complete import workflow: upload/paste -> preview -> geocoding -> merge. DataSummary shows current state. Merge behavior confirmed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete import flow</name>
  <what-built>
Complete Phase 1 data pipeline:
- Seed data (5 offices, 45 employees) loads on first visit
- CSV import with paste and file upload
- Preview before import with validation errors shown
- Geocoding with progress bar
- Merge behavior (new imports add to existing)
- German character handling
  </what-built>
  <how-to-verify>
1. Open http://localhost:5173
2. Verify seed data loaded: should show "5 offices, 45 employees"
3. Check German characters: expand employee list, look for umlauts (Mueller, etc.)

4. Test office import:
   a. Select "Import Offices" tab
   b. Paste this CSV:
      ```
      name,address
      Test Office,Alexanderplatz 1, 10178 Berlin
      ```
   c. Verify preview shows the row
   d. Click confirm
   e. Verify geocoding progress appears
   f. Verify "6 offices" after complete

5. Test employee import:
   a. Select "Import Employees" tab
   b. Paste this CSV:
      ```
      name;strasse;plz;stadt;team
      Hans Mueller;Hauptstr. 10;60311;Frankfurt;Platform
      Anna Schmidt;Berliner Str. 5;10117;Berlin;Frontend
      ;Missing Name;12345;Somewhere;InvalidTeam
      ```
   c. Verify preview shows 2 valid, 1 invalid
   d. Verify invalid row is highlighted with error message
   e. Click confirm
   f. Verify employees increase by 2 (not 3 - invalid skipped)

6. Test persistence:
   a. Refresh page
   b. Verify counts remain (data persisted)
   c. Clear localStorage, refresh
   d. Verify seed data reloads

7. Test file upload:
   a. Create a .csv file with employee data
   b. Drag-drop onto upload area
   c. Verify it parses correctly

Expected result: All 7 verification steps pass.
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Seed data loads on first visit (5 offices, 45 employees)
2. German characters display correctly in seed data
3. CSV paste triggers preview
4. File upload triggers preview
5. Preview shows valid/invalid row counts
6. Invalid rows highlighted with error messages
7. Confirm imports only valid rows
8. Geocoding progress bar shows during import
9. New imports merge with existing data
10. DataSummary shows accurate counts
11. Clear all data works
12. Data persists across page refresh
</verification>

<success_criteria>
Per ROADMAP Phase 1 Success Criteria:
1. User can paste office CSV and see parsed offices with coordinates
2. User can paste employee CSV and see parsed employees with coordinates
3. System displays sample data (5 offices, 30-50 employees) on first load
4. German characters display correctly after import
5. Geocoding progress is visible and completes without silent failures
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-data-pipeline/01-03-SUMMARY.md`
</output>
