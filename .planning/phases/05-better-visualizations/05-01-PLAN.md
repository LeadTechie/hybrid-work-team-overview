---
phase: 05-better-visualizations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/stores/filterStore.ts
  - src/utils/googleMapsUrl.ts
  - src/utils/markerIcons.ts
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "mapMode state exists in filterStore with 'normal' and 'grayscale' options"
    - "CSS class map-tiles-grayscale applies grayscale filter to map tiles"
    - "Selected employee marker has visible pulse animation and glow"
    - "Google Maps directions URL can be built from two coordinate pairs"
  artifacts:
    - path: "src/stores/filterStore.ts"
      provides: "mapMode state and setMapMode action"
      contains: "mapMode"
    - path: "src/utils/googleMapsUrl.ts"
      provides: "Google Maps directions URL builder"
      exports: ["buildGoogleMapsDirectionsUrl"]
    - path: "src/utils/markerIcons.ts"
      provides: "Enhanced selected marker with distinct className"
      contains: "employee-marker-selected"
    - path: "src/App.css"
      provides: "Grayscale tile CSS, pulse animation, distance tooltip styles"
      contains: "map-tiles-grayscale"
  key_links:
    - from: "src/stores/filterStore.ts"
      to: "MapView (Plan 02)"
      via: "mapMode state consumed by TileLayer"
      pattern: "mapMode"
    - from: "src/utils/googleMapsUrl.ts"
      to: "EmployeeMarker (Plan 02)"
      via: "buildGoogleMapsDirectionsUrl called in popup"
      pattern: "buildGoogleMapsDirectionsUrl"
---

<objective>
Add state, utilities, and CSS foundations for Phase 5 visualization enhancements.

Purpose: Establish the non-component building blocks (store state, utility functions, CSS classes) that Plan 02 will wire into the UI components.
Output: Updated filterStore with mapMode, new googleMapsUrl utility, enhanced marker icons for selected state, CSS for grayscale tiles + pulse animation + distance tooltips.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-better-visualizations/05-RESEARCH.md

@src/stores/filterStore.ts
@src/utils/markerIcons.ts
@src/utils/distance.ts
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mapMode state and Google Maps URL utility</name>
  <files>src/stores/filterStore.ts, src/utils/googleMapsUrl.ts</files>
  <action>
1. In `src/stores/filterStore.ts`:
   - Add `MapMode` type export: `export type MapMode = 'normal' | 'grayscale';`
   - Add `mapMode: MapMode` field to FilterState interface (default: `'normal'`)
   - Add `setMapMode: (mode: MapMode) => void` action to FilterState interface
   - Add `mapMode: 'normal'` to initial state
   - Add `setMapMode: (mode) => set({ mapMode: mode })` to actions
   - Do NOT reset mapMode in clearFilters (same pattern as colorBy -- visual preference, not a filter)

2. Create `src/utils/googleMapsUrl.ts`:
   - Export `buildGoogleMapsDirectionsUrl(origin: { lat: number; lon: number }, destination: { lat: number; lon: number }, travelMode?: 'driving' | 'transit' | 'walking' | 'bicycling'): string`
   - Default travelMode is `'driving'`
   - Returns: `https://www.google.com/maps/dir/?api=1&origin=${origin.lat},${origin.lon}&destination=${destination.lat},${destination.lon}&travelmode=${travelMode}`
   - Pure function, no side effects
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Verify filterStore exports MapMode type and has mapMode/setMapMode. Verify googleMapsUrl.ts exports buildGoogleMapsDirectionsUrl.
  </verify>
  <done>filterStore has mapMode state with getter/setter. googleMapsUrl utility builds correct Google Maps directions URLs.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance marker icons and add CSS for grayscale, pulse, and distance tooltips</name>
  <files>src/utils/markerIcons.ts, src/App.css</files>
  <action>
1. In `src/utils/markerIcons.ts`:
   - Modify `createEmployeeIcon` to use className `'employee-marker-selected'` when `isHighlighted` is true, keeping `'employee-marker'` when false
   - This enables CSS targeting for the pulse animation on selected markers
   - Keep existing size (35 vs 25) and strokeWidth (3 vs 2) differences

2. In `src/App.css`, add at the end (before the responsive section):

   **Grayscale map tiles:**
   ```css
   /* Grayscale map mode */
   .map-tiles-grayscale {
     filter: grayscale(100%) brightness(105%);
   }
   ```

   **Selected marker pulse animation:**
   ```css
   /* Selected employee marker pulse */
   .employee-marker-selected svg {
     filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.8));
     animation: marker-pulse 1.5s ease-in-out infinite;
   }

   @keyframes marker-pulse {
     0%, 100% { transform: scale(1); }
     50% { transform: scale(1.15); }
   }
   ```

   **Distance tooltip styling:**
   ```css
   /* Distance line tooltips */
   .distance-tooltip {
     background: rgba(30, 41, 59, 0.9) !important;
     color: #fff !important;
     border: none !important;
     border-radius: 4px !important;
     padding: 2px 8px !important;
     font-size: 12px !important;
     font-weight: 500 !important;
     white-space: nowrap !important;
     box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
   }

   .distance-tooltip::before {
     display: none !important;
   }
   ```

   **Map mode toggle styling:**
   ```css
   /* Map mode toggle */
   .map-mode-toggle {
     display: flex;
     align-items: center;
     gap: 8px;
     padding: 8px 0;
   }

   .map-mode-toggle label {
     font-size: 13px;
     font-weight: 500;
     color: #374151;
     cursor: pointer;
     display: flex;
     align-items: center;
     gap: 8px;
   }

   .map-mode-toggle input[type="checkbox"] {
     width: 16px;
     height: 16px;
     cursor: pointer;
   }
   ```
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Visually inspect App.css for correct CSS syntax. Check that markerIcons.ts uses `employee-marker-selected` className for highlighted markers.
  </verify>
  <done>Selected markers use `employee-marker-selected` className for CSS pulse targeting. App.css has grayscale, pulse animation, distance tooltip, and map mode toggle styles.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. filterStore exports: MapMode type, mapMode state, setMapMode action
4. googleMapsUrl.ts exports buildGoogleMapsDirectionsUrl
5. markerIcons.ts uses 'employee-marker-selected' className for highlighted state
6. App.css contains .map-tiles-grayscale, @keyframes marker-pulse, .distance-tooltip, .map-mode-toggle classes
</verification>

<success_criteria>
- TypeScript compiles with no errors
- All new exports are importable
- CSS classes ready for Plan 02 component wiring
- No runtime behavior changes yet (foundations only)
</success_criteria>

<output>
After completion, create `.planning/phases/05-better-visualizations/05-01-SUMMARY.md`
</output>
