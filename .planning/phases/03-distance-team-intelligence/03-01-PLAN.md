---
phase: 03-distance-team-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/distance.ts
  - src/stores/filterStore.ts
  - src/components/CircuityInfoModal.tsx
autonomous: true

must_haves:
  truths:
    - "Circuity factor functions exist and return distance-dependent multipliers (1.4 short, 1.35 medium, 1.25 long)"
    - "formatDistance can output road-estimate format with ~ prefix and appropriate rounding"
    - "filterStore has useRoadDistance boolean toggle that defaults to false"
    - "CircuityInfoModal renders an accessible modal explaining circuity with accuracy examples"
  artifacts:
    - path: "src/utils/distance.ts"
      provides: "getCircuityFactor, estimateRoadDistance, formatDistance (updated)"
      exports: ["getCircuityFactor", "estimateRoadDistance", "calculateDistance", "formatDistance"]
    - path: "src/stores/filterStore.ts"
      provides: "useRoadDistance state and setter"
      contains: "useRoadDistance"
    - path: "src/components/CircuityInfoModal.tsx"
      provides: "Info modal explaining circuity factor estimation"
      exports: ["CircuityInfoModal"]
  key_links:
    - from: "src/utils/distance.ts"
      to: "circuity factor constants"
      via: "getCircuityFactor function"
      pattern: "CIRCUITY_FACTOR"
    - from: "src/stores/filterStore.ts"
      to: "clearFilters"
      via: "useRoadDistance NOT reset by clearFilters"
      pattern: "useRoadDistance"
---

<objective>
Add circuity factor estimation functions to the existing distance utility, a store toggle for switching between straight-line and road-estimate distances, and an info modal explaining how circuity works.

Purpose: Foundation layer for the circuity toggle feature. These exports are consumed by Plan 02 which wires them into the UI.
Output: Updated distance.ts with circuity functions, updated filterStore.ts with toggle, new CircuityInfoModal.tsx component.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/utils/distance.ts
@src/stores/filterStore.ts
@src/components/AccurateGeocodingModal.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add circuity factor functions and road-estimate formatting to distance.ts</name>
  <files>src/utils/distance.ts</files>
  <action>
Add the following to `src/utils/distance.ts` BELOW the existing `formatDistance` function. Do NOT modify existing `calculateDistance` or `toRadians` functions.

1. **Circuity factor constants** (distance-dependent, research-backed for Germany/Europe):
   ```
   CIRCUITY_FACTOR_SHORT = 1.4    // < 20km straight-line (urban, local roads)
   CIRCUITY_FACTOR_MEDIUM = 1.35  // 20-100km (mixed roads)
   CIRCUITY_FACTOR_LONG = 1.25    // > 100km (mostly Autobahn)
   ```

2. **`getCircuityFactor(straightLineKm: number): number`** — returns the appropriate factor based on distance band. Export it.

3. **`estimateRoadDistance(straightLineKm: number): number`** — returns `straightLineKm * getCircuityFactor(straightLineKm)`. Export it.

4. **Update `formatDistance` signature** to accept a second optional parameter `useRoadEstimate?: boolean` (defaults to `false`):
   - When `useRoadEstimate` is `false`: existing behavior unchanged (`X.X km` or `XXX m`)
   - When `useRoadEstimate` is `true`: apply circuity factor first, then format with `~` prefix and appropriate rounding:
     - Under 10km road estimate: `~X km` (round to nearest integer)
     - 10-100km road estimate: `~XX km` (round to nearest 5)
     - Over 100km road estimate: `~XXX km` (round to nearest 10)
   - Null input still returns `'—'` regardless of flag

This approach means all 3 consumer components (EmployeeMarker, DistanceLines, EmployeesTable) can simply pass the `useRoadDistance` flag to `formatDistance` without changing their distance calculation logic. The haversine value feeds in, and `formatDistance` handles the circuity multiplication + formatting internally when the flag is true.
  </action>
  <verify>
Create a quick mental check of expected outputs:
- `formatDistance(50)` => `"50.0 km"` (unchanged)
- `formatDistance(50, true)` => circuity: 50 * 1.35 = 67.5 => round to nearest 5 => `"~70 km"`
- `formatDistance(5, true)` => circuity: 5 * 1.4 = 7 => `"~7 km"`
- `formatDistance(150, true)` => circuity: 150 * 1.25 = 187.5 => round to nearest 10 => `"~190 km"`
- `formatDistance(null, true)` => `"—"`
- `formatDistance(0.5, true)` => circuity: 0.5 * 1.4 = 0.7 => `"~1 km"`

Run: `npx tsc --noEmit` to confirm no type errors.
  </verify>
  <done>
distance.ts exports getCircuityFactor, estimateRoadDistance, and formatDistance now accepts optional useRoadEstimate boolean. All existing calls to formatDistance(km) continue working unchanged (backward compatible).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add useRoadDistance toggle to filterStore and create CircuityInfoModal</name>
  <files>src/stores/filterStore.ts, src/components/CircuityInfoModal.tsx</files>
  <action>
**Part A — filterStore.ts:**

Add to FilterState interface:
- `useRoadDistance: boolean`
- `setUseRoadDistance: (value: boolean) => void`

Add to store creation:
- Default: `useRoadDistance: false`
- Setter: `setUseRoadDistance: (value) => set({ useRoadDistance: value })`

Do NOT add `useRoadDistance` to the `clearFilters` reset list. Like `mapMode` and `disableClustering`, it is a visual preference that persists across filter clears. Add a comment: `// Note: useRoadDistance is intentionally NOT reset (visual preference, not filter)`

**Part B — CircuityInfoModal.tsx:**

Create a new component `src/components/CircuityInfoModal.tsx`. Follow the modal pattern from AccurateGeocodingModal.tsx (fixed overlay, role="dialog", aria-modal, z-index 1000, click-outside-close on overlay, white card with 12px border-radius, 24px padding, max-width 500px).

Props: `{ onClose: () => void }`

Content structure:
1. **Title:** "How Distance Estimation Works" (h2, id for aria-labelledby)

2. **Section: "As the Crow Flies"**
   - Explain: "By default, distances show the straight-line (haversine) distance between the employee's postcode centroid and the office. This is the shortest possible distance — as a bird would fly."

3. **Section: "Estimated Road Distance"**
   - Explain: "When enabled, distances are multiplied by a circuity factor — an empirically-measured ratio of actual road distance to straight-line distance. This accounts for the fact that roads don't go in straight lines."
   - Show the three bands:
     - Short distances (<20 km): factor 1.4 (urban streets, many turns)
     - Medium distances (20-100 km): factor 1.35 (mixed regional roads)
     - Long distances (>100 km): factor 1.25 (mostly Autobahn, more direct)

4. **Section: "Accuracy"**
   - "Road estimates are typically within 10-15% of actual driving distances for trips over 20 km."
   - "For shorter urban trips, accuracy is lower due to complex street networks."
   - "All estimated distances show a ~ prefix (e.g. ~70 km) to indicate they are approximations."

5. **Example box** (light blue background #eff6ff, border #bfdbfe):
   - "Example: An employee 50 km straight-line from an office"
   - "Straight-line: 50.0 km"
   - "Road estimate: ~70 km (50 x 1.35 factor)"
   - "Actual driving (Google Maps): typically 60-75 km"

6. **Source note** (small, gray text):
   - "Based on European circuity research (Mennicken, Lemoy & Caruso 2024; average 1.343)"

7. **Close button:** "Got it" — single button, right-aligned, blue (#4a90d9), calls onClose.

Click-outside-close: clicking the overlay (not the card) calls onClose.
  </action>
  <verify>
Run: `npx tsc --noEmit` to confirm no type errors.
Verify filterStore has useRoadDistance in its interface and creation.
Verify CircuityInfoModal.tsx exists and exports CircuityInfoModal.
  </verify>
  <done>
filterStore exports useRoadDistance boolean (default false) with setter. CircuityInfoModal renders accessible info modal with circuity explanation, accuracy examples, and close button. useRoadDistance is NOT reset by clearFilters.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `formatDistance(50)` returns `"50.0 km"` (backward compatible)
3. `formatDistance(50, true)` returns road estimate with ~ prefix
4. filterStore.getState().useRoadDistance === false (default)
5. CircuityInfoModal component exists and can be imported
</verification>

<success_criteria>
- distance.ts has getCircuityFactor, estimateRoadDistance exports
- formatDistance accepts optional useRoadEstimate parameter without breaking existing callers
- filterStore has useRoadDistance toggle, not reset by clearFilters
- CircuityInfoModal renders explanatory content with example and close button
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-distance-team-intelligence/03-01-SUMMARY.md`
</output>
