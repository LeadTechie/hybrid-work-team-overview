---
phase: 02.1-security-privacy-hardening
plan: 04
type: execute
wave: 3
depends_on: ["02.1-02", "02.1-03"]
files_modified:
  - src/components/ClearDataButton.tsx
  - src/components/import/CsvUploader.tsx
  - src/data/seedOffices.ts
  - src/data/seedEmployees.ts
  - src/services/csvService.ts
  - src/components/import/ImportPanel.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can clear all stored data via visible button"
    - "File upload rejects files larger than 5MB"
    - "Import enforces employee (1000) and office (20) limits"
    - "Seed data uses new postcode-based format"
    - "CSV parsing extracts postcode, uses local geocoding"
  artifacts:
    - path: "src/components/ClearDataButton.tsx"
      provides: "Button to wipe all localStorage and reset stores"
      exports: ["ClearDataButton"]
      min_lines: 20
    - path: "src/components/import/CsvUploader.tsx"
      provides: "CSV uploader with file size limit"
      contains: "MAX_FILE_SIZE"
    - path: "src/components/import/ImportPanel.tsx"
      provides: "Import with data limits validation"
      contains: "DATA_LIMITS"
    - path: "src/data/seedEmployees.ts"
      provides: "Seed employees with postcode format"
      contains: "postcode:"
  key_links:
    - from: "src/components/ClearDataButton.tsx"
      to: "localStorage.clear()"
      via: "clear all data function"
      pattern: "localStorage\\.clear"
    - from: "src/components/import/ImportPanel.tsx"
      to: "src/services/validationService.ts"
      via: "DATA_LIMITS import"
      pattern: "DATA_LIMITS\\.(MAX_EMPLOYEES|MAX_OFFICES)"
    - from: "src/components/import/ImportPanel.tsx"
      to: "src/services/localGeocodingService.ts"
      via: "geocodeByPostcode for imported data"
      pattern: "geocodeByPostcode"
---

<objective>
Complete security hardening with clear data button, file size limits, data count limits, and migrate to postcode-based geocoding.

Purpose: Enable user data control (clear button), enforce limits, and wire up local geocoding for CSV imports.
Output: ClearDataButton, file size validation, import limits, updated seed data and CSV parsing
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-security-privacy-hardening/02.1-RESEARCH.md
@.planning/phases/02.1-security-privacy-hardening/02.1-02-SUMMARY.md
@.planning/phases/02.1-security-privacy-hardening/02.1-03-SUMMARY.md
@src/components/import/CsvUploader.tsx
@src/components/import/ImportPanel.tsx
@src/data/seedOffices.ts
@src/data/seedEmployees.ts
@src/services/csvService.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClearDataButton and add file size limit</name>
  <files>
    src/components/ClearDataButton.tsx
    src/components/import/CsvUploader.tsx
  </files>
  <action>
1. Create `src/components/ClearDataButton.tsx`:
```typescript
import { useEmployeeStore } from '../stores/employeeStore';
import { useOfficeStore } from '../stores/officeStore';

export function ClearDataButton() {
  const clearEmployees = useEmployeeStore((state) => state.clearEmployees);
  const clearOffices = useOfficeStore((state) => state.clearOffices);

  const handleClear = () => {
    if (window.confirm('Are you sure you want to delete all data? This cannot be undone.')) {
      // Clear Zustand stores
      clearEmployees();
      clearOffices();

      // Clear all localStorage
      localStorage.clear();

      // Clear sessionStorage (API key if any)
      sessionStorage.clear();

      // Force reload to reset app state
      window.location.reload();
    }
  };

  return (
    <button
      onClick={handleClear}
      style={{
        padding: '8px 16px',
        backgroundColor: '#ffebee',
        color: '#c62828',
        border: '1px solid #ef9a9a',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '13px',
        display: 'flex',
        alignItems: 'center',
        gap: '6px',
      }}
      title="Delete all stored data from your browser"
    >
      <span>üóëÔ∏è</span>
      <span>Clear All Data</span>
    </button>
  );
}
```

2. Update `src/components/import/CsvUploader.tsx` to add file size limit:
   - Import DATA_LIMITS: `import { DATA_LIMITS } from '../../services/validationService';`
   - In onDrop callback, check file size before reading:
   ```typescript
   const onDrop = useCallback((acceptedFiles: File[]) => {
     if (acceptedFiles.length > 0) {
       const file = acceptedFiles[0];

       // Check file size limit
       const maxBytes = DATA_LIMITS.MAX_FILE_SIZE_MB * 1024 * 1024;
       if (file.size > maxBytes) {
         alert(`File too large. Maximum size is ${DATA_LIMITS.MAX_FILE_SIZE_MB}MB.`);
         return;
       }

       handleFileRead(file);
     }
   }, [handleFileRead]);
   ```
  </action>
  <verify>
    - `grep "localStorage.clear" src/components/ClearDataButton.tsx` confirms clearing
    - `grep "MAX_FILE_SIZE" src/components/import/CsvUploader.tsx` confirms limit check
    - `npm run build` succeeds
  </verify>
  <done>
    ClearDataButton wipes all data, CsvUploader rejects files >5MB
  </done>
</task>

<task type="auto">
  <name>Task 2: Update seed data to postcode format</name>
  <files>
    src/data/seedOffices.ts
    src/data/seedEmployees.ts
  </files>
  <action>
1. Update `src/data/seedOffices.ts`:
   - Change Office objects to use postcode, street, city instead of address
   - Use existing coords (pre-geocoded offices remain as-is)
   - Add geocodeAccuracy: 'address' since these are pre-defined locations

Example transformation:
```typescript
// Before
{ id: '1', name: 'Berlin HQ', address: 'Unter den Linden 1, 10117 Berlin', coords: {...} }

// After
{ id: '1', name: 'Berlin HQ', postcode: '10117', street: 'Unter den Linden 1', city: 'Berlin', coords: {...}, geocodeStatus: 'success' }
```

2. Update `src/data/seedEmployees.ts`:
   - Change Employee objects to use postcode instead of address
   - Extract postcode from address (German postcodes are 5 digits before city name)
   - Add geocodeAccuracy: 'postcode-centroid'
   - Use local geocoding to set coords

Import and use local geocoding:
```typescript
import { geocodeByPostcode } from '../services/localGeocodingService';
```

For each employee:
- Extract postcode from address (regex: /(\d{5})\s+\w/)
- Call geocodeByPostcode(postcode)
- Set coords from result, geocodeAccuracy: 'postcode-centroid'
- Set street (everything before postcode) and city (from geocoding or address)
  </action>
  <verify>
    - `grep "postcode:" src/data/seedOffices.ts` confirms new format
    - `grep "postcode:" src/data/seedEmployees.ts` confirms new format
    - `grep "geocodeAccuracy" src/data/seedEmployees.ts` confirms accuracy field
    - `npm run build` succeeds
  </verify>
  <done>
    Seed data uses postcode-based format with local geocoding
  </done>
</task>

<task type="auto">
  <name>Task 3: Update CSV parsing and import to use local geocoding with limits</name>
  <files>
    src/services/csvService.ts
    src/components/import/ImportPanel.tsx
  </files>
  <action>
1. Update `src/services/csvService.ts`:
   - Update parseOfficeCsv to expect postcode, street (optional), city (optional) columns
   - Update parseEmployeeCsv to expect postcode, street (optional), city (optional), team columns
   - Use geocodeByPostcode for coordinates
   - Set geocodeAccuracy based on postcode lookup success

```typescript
import { geocodeByPostcode } from './localGeocodingService';

// In mapToEmployee or similar:
const geocodeResult = geocodeByPostcode(validated.postcode);
return {
  id: generateId(),
  name: validated.name,
  postcode: validated.postcode,
  street: validated.street,
  city: validated.city || geocodeResult.city || undefined,
  team: validated.team,
  department: validated.department,
  role: validated.role,
  assignedOffice: validated.assignedOffice,
  coords: geocodeResult.coords ?? undefined,
  geocodeAccuracy: 'postcode-centroid',
  geocodeStatus: geocodeResult.coords ? 'success' : 'failed',
};
```

2. Update `src/components/import/ImportPanel.tsx`:
   - Import DATA_LIMITS: `import { DATA_LIMITS } from '../../services/validationService';`
   - Before import, check if adding new records would exceed limits:
   ```typescript
   const handleImport = () => {
     if (!parseResult || parseResult.valid.length === 0) return;

     const currentCount = importType === 'offices' ? offices.length : employees.length;
     const limit = importType === 'offices' ? DATA_LIMITS.MAX_OFFICES : DATA_LIMITS.MAX_EMPLOYEES;
     const newTotal = currentCount + parseResult.valid.length;

     if (newTotal > limit) {
       setError(`Cannot import: would exceed ${limit} ${importType} limit. ` +
         `Current: ${currentCount}, Importing: ${parseResult.valid.length}`);
       return;
     }

     // ... proceed with import
   };
   ```
   - Remove async geocoding - local geocoding is synchronous, no progress indicator needed
   - Simplify import flow since no network calls required
  </action>
  <verify>
    - `grep "geocodeByPostcode" src/services/csvService.ts` confirms local geocoding
    - `grep "DATA_LIMITS" src/components/import/ImportPanel.tsx` confirms limit checks
    - `npm run build` succeeds
  </verify>
  <done>
    CSV import uses local geocoding, enforces data limits
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire up PrivacyBadge and ClearDataButton in App</name>
  <files>
    src/App.tsx
  </files>
  <action>
Update `src/App.tsx` to include PrivacyBadge and ClearDataButton in the sidebar:

1. Add imports:
```typescript
import { PrivacyBadge } from './components/PrivacyBadge';
import { ClearDataButton } from './components/ClearDataButton';
```

2. Add components to sidebar (after DataSummary):
```typescript
<aside className="sidebar">
  <EmployeeSearch />
  <FilterPanel />
  <DataSummary />
  <div style={{ marginTop: 'auto', display: 'flex', flexDirection: 'column', gap: '12px', paddingTop: '16px' }}>
    <PrivacyBadge />
    <ClearDataButton />
  </div>
</aside>
```

The PrivacyBadge and ClearDataButton should be at the bottom of the sidebar, visually separated from the main controls.
  </action>
  <verify>
    - `grep "PrivacyBadge" src/App.tsx` confirms import and usage
    - `grep "ClearDataButton" src/App.tsx` confirms import and usage
    - `npm run dev` shows app with privacy badge and clear button in sidebar
    - `npm run build` succeeds
  </verify>
  <done>
    App displays privacy badge and clear data button in sidebar
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` starts and shows:
   - Privacy badge in sidebar ("All data stays in browser")
   - Clear data button in sidebar
   - Map loads with seed data
3. Clear data button works (confirm dialog, clears, reloads)
4. File upload rejects files >5MB
5. Seed data displays correctly on map
</verification>

<success_criteria>
- ClearDataButton visible and functional
- PrivacyBadge visible in sidebar
- File size limit enforced (5MB)
- Data count limits enforced (1000 employees, 20 offices)
- Seed data in postcode format with local geocoding
- CSV import uses local geocoding (no network calls)
- App builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-security-privacy-hardening/02.1-04-SUMMARY.md`
</output>
