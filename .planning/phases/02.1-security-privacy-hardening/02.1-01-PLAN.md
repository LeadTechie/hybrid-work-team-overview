---
phase: 02.1-security-privacy-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/encryptedStorage.ts
  - src/services/validationService.ts
  - index.html
  - src/components/PrivacyBadge.tsx
autonomous: true

must_haves:
  truths:
    - "localStorage encryption adapter exists and works with Zustand persist"
    - "Data limits are defined (1000 employees, 20 offices)"
    - "CSP meta tag blocks external connections by default"
    - "Privacy badge component exists and indicates local processing"
  artifacts:
    - path: "src/services/encryptedStorage.ts"
      provides: "Zustand-compatible encrypted storage adapter"
      exports: ["EncryptedStorage", "encryptedStorage"]
      min_lines: 25
    - path: "src/services/validationService.ts"
      provides: "Validation schemas and data limits"
      contains: "DATA_LIMITS"
    - path: "index.html"
      provides: "CSP meta tag"
      contains: "Content-Security-Policy"
    - path: "src/components/PrivacyBadge.tsx"
      provides: "Privacy indicator component"
      exports: ["PrivacyBadge"]
      min_lines: 15
  key_links:
    - from: "src/services/encryptedStorage.ts"
      to: "crypto-js"
      via: "AES encrypt/decrypt"
      pattern: "CryptoJS\\.AES\\.(encrypt|decrypt)"
---

<objective>
Create foundational security infrastructure: encrypted storage adapter, data limits, CSP headers, and privacy badge.

Purpose: Establish the security building blocks that other plans depend on - encryption for stores, limits for validation, CSP for network protection.
Output: encryptedStorage.ts service, updated validationService.ts with DATA_LIMITS, CSP in index.html, PrivacyBadge.tsx component
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-security-privacy-hardening/02.1-RESEARCH.md
@src/services/validationService.ts
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install crypto-js and create encrypted storage adapter</name>
  <files>
    src/services/encryptedStorage.ts
    package.json
  </files>
  <action>
1. Install crypto-js and types:
   ```bash
   npm install crypto-js
   npm install -D @types/crypto-js
   ```

2. Create `src/services/encryptedStorage.ts` implementing Zustand's PersistStorage interface:
   - Import CryptoJS from 'crypto-js'
   - Use versioned key constant: `const STORAGE_KEY = 'hwto-v1'`
   - Implement EncryptedStorage class with:
     - `getItem(key: string): string | null` - decrypt from localStorage, return null on failure
     - `setItem(key: string, value: string): void` - encrypt and store
     - `removeItem(key: string): void` - remove from localStorage
   - Handle decryption failures gracefully (return null to trigger state reset)
   - Export both the class and a singleton instance `encryptedStorage`

Reference pattern from research:
```typescript
const decrypted = CryptoJS.AES.decrypt(value, STORAGE_KEY);
return decrypted.toString(CryptoJS.enc.Utf8) || null;
```
  </action>
  <verify>
    - File exists with correct imports
    - `npm run build` succeeds (no type errors)
  </verify>
  <done>
    EncryptedStorage class implements PersistStorage interface, handles encrypt/decrypt with graceful failure
  </done>
</task>

<task type="auto">
  <name>Task 2: Add data limits and update validation service</name>
  <files>
    src/services/validationService.ts
  </files>
  <action>
Add DATA_LIMITS constant to validationService.ts:

```typescript
export const DATA_LIMITS = {
  MAX_EMPLOYEES: 1000,
  MAX_OFFICES: 20,
  MAX_FILE_SIZE_MB: 5,
} as const;
```

Place this before the schema definitions. Keep all existing schemas unchanged for now (postcode changes come in Plan 03).
  </action>
  <verify>
    - `grep "DATA_LIMITS" src/services/validationService.ts` returns the constant
    - `npm run build` succeeds
  </verify>
  <done>
    DATA_LIMITS exported with MAX_EMPLOYEES=1000, MAX_OFFICES=20, MAX_FILE_SIZE_MB=5
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSP meta tag and create PrivacyBadge component</name>
  <files>
    index.html
    src/components/PrivacyBadge.tsx
  </files>
  <action>
1. Update `index.html` - add CSP meta tag in head section after viewport meta:
```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' https://*.tile.openstreetmap.org data:; connect-src 'self';">
```

Note: 'unsafe-inline' needed for Vite HMR in dev. connect-src 'self' blocks external API calls by default.

2. Create `src/components/PrivacyBadge.tsx`:
- Simple functional component showing privacy status
- Use inline styles consistent with app design (no external CSS needed)
- Display lock icon and "All data stays in browser" text
- Add tooltip explaining local processing
- Style: small badge, subtle background, positioned for sidebar placement

```typescript
export function PrivacyBadge() {
  return (
    <div
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: '6px',
        padding: '8px 12px',
        backgroundColor: '#e8f5e9',
        borderRadius: '6px',
        fontSize: '13px',
        color: '#2e7d32',
      }}
      title="All calculations performed locally in your browser. No data is sent to any server."
    >
      <span>ðŸ”’</span>
      <span>All data stays in your browser</span>
    </div>
  );
}
```
  </action>
  <verify>
    - `grep "Content-Security-Policy" index.html` finds the meta tag
    - `grep "PrivacyBadge" src/components/PrivacyBadge.tsx` confirms component exists
    - `npm run dev` starts without CSP errors (check console)
  </verify>
  <done>
    CSP blocks external connections, PrivacyBadge component ready for use in sidebar
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` starts and map tiles load (CSP allows openstreetmap)
3. Console shows no CSP violation errors during normal use
4. Files created: encryptedStorage.ts, PrivacyBadge.tsx
5. Files modified: validationService.ts, index.html
</verification>

<success_criteria>
- crypto-js installed and typed
- EncryptedStorage class ready for Zustand integration
- DATA_LIMITS constant exported
- CSP meta tag in index.html blocks connect-src except 'self'
- PrivacyBadge component exists and renders
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-security-privacy-hardening/02.1-01-SUMMARY.md`
</output>
