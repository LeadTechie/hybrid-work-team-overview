---
phase: 02-map-filtering
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/components/map/MapLegend.tsx
  - src/components/map/MapView.tsx
  - src/App.tsx
  - src/App.css
autonomous: false

must_haves:
  truths:
    - "User sees interactive Germany map with office locations as distinct markers"
    - "User sees employee home locations as markers on the map"
    - "User can color-code markers by team, department, or assigned office"
    - "User can filter employees by team, department, or assigned office"
    - "User can search for an employee by name and see them highlighted on map"
    - "User sees a legend explaining the current color coding"
  artifacts:
    - path: "src/components/map/MapLegend.tsx"
      provides: "Color legend for current colorBy mode"
      exports: ["MapLegend"]
    - path: "src/App.tsx"
      provides: "Integrated app with map and filters"
      min_lines: 30
  key_links:
    - from: "src/App.tsx"
      to: "src/components/map/MapView.tsx"
      via: "renders MapView"
      pattern: "<MapView"
    - from: "src/App.tsx"
      to: "src/components/filters/FilterPanel.tsx"
      via: "renders FilterPanel"
      pattern: "<FilterPanel"
    - from: "src/components/map/MapView.tsx"
      to: "src/hooks/useFilteredEmployees.ts"
      via: "uses filtered data"
      pattern: "useFilteredEmployees"
---

<objective>
Wire all Phase 2 components together into the main application and verify complete functionality.

Purpose: Integrates the map, filter panel, search, and legend into a cohesive UI that meets all Phase 2 requirements.

Output:
- MapLegend.tsx: Shows color meanings for current colorBy mode
- Updated MapView.tsx: Uses useFilteredEmployees hook
- Updated App.tsx: Renders map, filters, and search in proper layout
- Updated App.css: Styles for filter panel, search, legend, and responsive layout
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-map-filtering/02-RESEARCH.md

@src/App.tsx
@src/App.css
@src/components/map/MapView.tsx
@src/components/filters/FilterPanel.tsx
@src/components/filters/EmployeeSearch.tsx
@src/stores/filterStore.ts
@src/utils/markerColors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MapLegend component</name>
  <files>src/components/map/MapLegend.tsx</files>
  <action>
Create MapLegend.tsx that shows the color meanings for the current colorBy mode.

Get colorBy from useFilterStore.
Import TEAM_COLORS, DEPARTMENT_COLORS, OFFICE_COLORS from markerColors.ts.

Select the appropriate color map based on colorBy:
- 'team' -> TEAM_COLORS
- 'department' -> DEPARTMENT_COLORS
- 'assignedOffice' -> OFFICE_COLORS

Render:
- Container div with className="map-legend"
- Title based on colorBy: "Teams", "Departments", or "Offices"
- For each entry in the color map:
  - Small colored circle (12px, border-radius 50%)
  - Label text
- Skip entries where key is 'default'

Style the legend to be positioned in bottom-right corner of map (position: absolute).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/map/MapLegend.tsx`</verify>
  <done>MapLegend shows current color meanings based on colorBy setting</done>
</task>

<task type="auto">
  <name>Task 2: Update MapView to use filtered employees and add legend</name>
  <files>src/components/map/MapView.tsx</files>
  <action>
Update MapView.tsx:

1. Import useFilteredEmployees from '../hooks/useFilteredEmployees'
2. Import MapLegend from './MapLegend'
3. Replace direct useEmployeeStore usage with useFilteredEmployees()
4. Get selectedEmployeeId from useFilterStore
5. Find selectedEmployee from filteredEmployees where id matches
6. Pass selectedEmployee to MapController
7. Render MapLegend inside the MapContainer (it will position itself)

The component should now:
- Show only filtered employees
- Animate to selected employee when search selects one
- Display legend in corner
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/map/MapView.tsx`</verify>
  <done>MapView uses filtered data and includes legend</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into App.tsx with layout and styles</name>
  <files>src/App.tsx, src/App.css</files>
  <action>
**App.tsx:**
Replace current content with integrated layout:

```typescript
import { MapView } from './components/map/MapView';
import { FilterPanel } from './components/filters/FilterPanel';
import { EmployeeSearch } from './components/filters/EmployeeSearch';
import { DataSummary } from './components/DataSummary';
import './App.css';

function App() {
  return (
    <div className="app">
      <header className="app-header">
        <h1>Hybrid Office Finder</h1>
      </header>
      <div className="app-content">
        <aside className="sidebar">
          <EmployeeSearch />
          <FilterPanel />
          <DataSummary />
        </aside>
        <main className="map-container">
          <MapView />
        </main>
      </div>
    </div>
  );
}

export default App;
```

**App.css:**
Add styles for the layout (keep existing styles, add new ones):

```css
.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.app-header {
  background: #1a365d;
  color: white;
  padding: 0.75rem 1rem;
  flex-shrink: 0;
}

.app-header h1 {
  margin: 0;
  font-size: 1.25rem;
}

.app-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.sidebar {
  width: 280px;
  padding: 1rem;
  background: #f7fafc;
  border-right: 1px solid #e2e8f0;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.map-container {
  flex: 1;
  position: relative;
}

/* Filter Panel Styles */
.filter-panel {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.filter-panel label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 0.25rem;
  color: #4a5568;
}

.filter-panel select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  font-size: 0.875rem;
}

.filter-panel button {
  margin-top: 0.5rem;
  padding: 0.5rem 1rem;
  background: #e2e8f0;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.875rem;
}

.filter-panel button:hover {
  background: #cbd5e0;
}

/* Employee Search Styles */
.employee-search {
  position: relative;
}

.employee-search input {
  width: 100%;
  padding: 0.5rem;
  padding-right: 2rem;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  font-size: 0.875rem;
  box-sizing: border-box;
}

.employee-search .clear-btn {
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  color: #a0aec0;
  font-size: 1rem;
  padding: 0;
}

.employee-search .suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 4px;
  margin-top: 2px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  list-style: none;
  padding: 0;
  margin: 0;
}

.employee-search .suggestions li button {
  width: 100%;
  padding: 0.5rem;
  text-align: left;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 0.875rem;
}

.employee-search .suggestions li button:hover {
  background: #edf2f7;
}

/* Map Legend Styles */
.map-legend {
  position: absolute;
  bottom: 20px;
  right: 10px;
  background: white;
  padding: 0.75rem;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  max-height: 200px;
  overflow-y: auto;
}

.map-legend h4 {
  margin: 0 0 0.5rem 0;
  font-size: 0.75rem;
  text-transform: uppercase;
  color: #718096;
}

.map-legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  margin-bottom: 0.25rem;
}

.map-legend-color {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* Responsive */
@media (max-width: 768px) {
  .app-content {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    max-height: 200px;
    border-right: none;
    border-bottom: 1px solid #e2e8f0;
  }
}
```

Ensure html, body, #root all have height: 100% and margin: 0 in index.css.
  </action>
  <verify>Run `npm run build` - build succeeds without errors</verify>
  <done>App integrates all components in responsive layout</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 map and filtering implementation</what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173

2. Verify MAP-01 (Germany map with offices):
   - Map shows Germany centered
   - 5 office locations visible as building icons
   - Click office marker to see name and city in popup

3. Verify MAP-02 (Employee markers):
   - Employee home locations shown as colored pin markers
   - Markers cluster when zoomed out
   - Click employee marker to see name, team, department

4. Verify MAP-03 (Color coding):
   - Change "Color by" dropdown to Team, Department, Assigned Office
   - Markers change color accordingly
   - Legend updates to show current color meanings

5. Verify FILT-01, FILT-02, FILT-03 (Filtering):
   - Select a Team filter - only that team's employees visible
   - Select a Department filter - filters combine with team
   - Select an Office filter - filters combine
   - Click "Clear Filters" - all employees return

6. Verify FILT-04 (Search):
   - Type employee name in search box
   - Autocomplete suggestions appear after 2 characters
   - Click a suggestion - map animates to that employee
   - Selected employee marker is larger/highlighted
  </how-to-verify>
  <resume-signal>Type "approved" if all requirements work, or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Run `npm run build` - no errors
2. Run `npm run dev` - app loads without console errors
3. All 7 requirements (MAP-01, MAP-02, MAP-03, FILT-01-04) verified in UI
</verification>

<success_criteria>
Phase 2 is complete when:
- Map shows Germany with office and employee markers
- Color coding works for team/department/office
- Filtering by team/department/office works
- Employee search with flyTo animation works
- Legend displays current color meanings
- Layout is responsive
</success_criteria>

<output>
After completion, create `.planning/phases/02-map-filtering/02-04-SUMMARY.md`
</output>
