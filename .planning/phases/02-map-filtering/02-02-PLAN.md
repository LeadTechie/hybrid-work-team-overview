---
phase: 02-map-filtering
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/map/MapView.tsx
  - src/components/map/OfficeMarker.tsx
  - src/components/map/EmployeeMarker.tsx
  - src/components/map/MapController.tsx
autonomous: true

must_haves:
  truths:
    - "User sees Germany map centered at [51.1657, 10.4515] with zoom 6"
    - "Office locations render as distinct building icons"
    - "Employee locations render as colored pin markers"
    - "Map animates to selected employee location"
  artifacts:
    - path: "src/components/map/MapView.tsx"
      provides: "Main map container with tile layer"
      exports: ["MapView"]
      min_lines: 40
    - path: "src/components/map/OfficeMarker.tsx"
      provides: "Office marker with popup"
      exports: ["OfficeMarker"]
    - path: "src/components/map/EmployeeMarker.tsx"
      provides: "Color-coded employee marker"
      exports: ["EmployeeMarker"]
    - path: "src/components/map/MapController.tsx"
      provides: "FlyTo animation controller"
      exports: ["MapController"]
  key_links:
    - from: "src/components/map/MapView.tsx"
      to: "react-leaflet"
      via: "MapContainer, TileLayer imports"
      pattern: "import.*from 'react-leaflet'"
    - from: "src/components/map/EmployeeMarker.tsx"
      to: "src/utils/markerIcons.ts"
      via: "createEmployeeIcon call"
      pattern: "createEmployeeIcon"
    - from: "src/components/map/MapController.tsx"
      to: "react-leaflet"
      via: "useMap hook for flyTo"
      pattern: "useMap\\(\\)"
---

<objective>
Create the core map components for visualizing offices and employees on an interactive Germany map.

Purpose: Implements the main visualization layer that shows office and employee locations with distinct marker styles and supports programmatic navigation for search highlighting.

Output:
- MapView.tsx: Main map container with OpenStreetMap tiles, Germany center, marker clustering
- OfficeMarker.tsx: Building icon marker with popup showing office name and city
- EmployeeMarker.tsx: Colored pin marker with popup, memoized icon creation
- MapController.tsx: FlyTo animation when employee is selected
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-map-filtering/02-RESEARCH.md

@src/stores/filterStore.ts
@src/stores/officeStore.ts
@src/stores/employeeStore.ts
@src/utils/markerIcons.ts
@src/utils/markerColors.ts
@src/types/employee.ts
@src/types/office.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create map directory and base MapView component</name>
  <files>src/components/map/MapView.tsx</files>
  <action>
Create src/components/map/ directory and MapView.tsx.

Import CSS at top (critical - see pitfall #1 in research):
```typescript
import 'leaflet/dist/leaflet.css';
import 'react-leaflet-cluster/dist/assets/MarkerCluster.css';
import 'react-leaflet-cluster/dist/assets/MarkerCluster.Default.css';
```

Constants:
- GERMANY_CENTER: [51.1657, 10.4515] as [number, number]
- INITIAL_ZOOM = 6

MapView component:
- Use MapContainer with center={GERMANY_CENTER}, zoom={INITIAL_ZOOM}, minZoom={5}, maxZoom={18}
- Add TileLayer with OpenStreetMap URL: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
- Include attribution: '&amp;copy; &lt;a href="https://www.openstreetmap.org/copyright"&gt;OpenStreetMap&lt;/a&gt;'
- Style container: height: '100%', width: '100%'
- Render MapController (for flyTo)
- Render office markers (NOT clustered - offices should always be visible)
- Render MarkerClusterGroup from react-leaflet-cluster with chunkedLoading prop containing employee markers
- Get offices from useOfficeStore, filtered employees from hook (will create in plan 03), colorBy and selectedEmployeeId from useFilterStore

For now, render employees directly from useEmployeeStore (we'll wire useFilteredEmployees in plan 03).

Filter to only render employees with valid coords (geocodeStatus === 'success').
  </action>
  <verify>File exists and TypeScript compiles: `npx tsc --noEmit src/components/map/MapView.tsx`</verify>
  <done>MapView renders MapContainer with tiles, ready for markers</done>
</task>

<task type="auto">
  <name>Task 2: Create OfficeMarker and EmployeeMarker components</name>
  <files>src/components/map/OfficeMarker.tsx, src/components/map/EmployeeMarker.tsx</files>
  <action>
**OfficeMarker.tsx:**
- Props: { office: Office }
- Only render if office.coords exists
- Use Marker from react-leaflet with position={[office.coords.lat, office.coords.lon]}
- Use createOfficeIcon() for the icon
- Add Popup with office.name and office.city
- Memoize icon with useMemo (empty deps - office icon is static)

**EmployeeMarker.tsx:**
- Props: { employee: Employee, colorBy: 'team' | 'department' | 'assignedOffice', isHighlighted?: boolean }
- Only render if employee.coords exists
- Use getColorForEmployee(employee, colorBy) to get color
- Use createEmployeeIcon(color, isHighlighted) for icon
- Memoize icon with useMemo, deps: [color, isHighlighted]
- Add Popup with employee.name, employee.team, and employee.department
- Wrap component with React.memo to prevent unnecessary re-renders

Both components import Marker, Popup from 'react-leaflet'.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/map/OfficeMarker.tsx src/components/map/EmployeeMarker.tsx`</verify>
  <done>Both marker components render with correct icons and popups</done>
</task>

<task type="auto">
  <name>Task 3: Create MapController for flyTo animation</name>
  <files>src/components/map/MapController.tsx</files>
  <action>
Create MapController following research Pattern 4.

Props: { selectedEmployee: Employee | null }

Use useMap() hook from react-leaflet to get map instance.

useEffect that watches selectedEmployee:
- If selectedEmployee?.coords exists:
  - Call map.flyTo([coords.lat, coords.lon], 14, { duration: 1.5 })
- Dependency array: [selectedEmployee, map]

Return null (this is a controller component, not visual).

Export MapController.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/components/map/MapController.tsx`</verify>
  <done>MapController animates map to selected employee location</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. All four files exist in src/components/map/
3. MapView imports Leaflet CSS files
4. MapView uses MarkerClusterGroup for employees
5. EmployeeMarker uses memoized icons
6. MapController uses useMap hook
</verification>

<success_criteria>
- MapView renders centered on Germany with OpenStreetMap tiles
- OfficeMarker shows building icon with office info popup
- EmployeeMarker shows colored pin based on colorBy prop with employee info popup
- MapController smoothly animates to selected employee
- All components type-safe with no compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-map-filtering/02-02-SUMMARY.md`
</output>
