---
phase: 02.1-security-privacy-hardening
plan: 05
type: execute
wave: 3
depends_on: ["02.1-03", "02.1-04"]
files_modified:
  - src/components/AccurateGeocodingModal.tsx
  - src/services/geocodingService.ts
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Accurate geocoding requires explicit user consent"
    - "User must provide their own API key (not bundled)"
    - "Consent modal has equal button prominence (GDPR)"
    - "API key stored in sessionStorage only (cleared on tab close)"
  artifacts:
    - path: "src/components/AccurateGeocodingModal.tsx"
      provides: "Consent modal for external geocoding"
      exports: ["AccurateGeocodingModal"]
      min_lines: 80
    - path: "src/services/geocodingService.ts"
      provides: "Updated geocoding with user-provided API key"
      exports: ["batchGeocode", "getApiKey", "setApiKey", "clearApiKey"]
  key_links:
    - from: "src/components/AccurateGeocodingModal.tsx"
      to: "sessionStorage"
      via: "store user-provided API key"
      pattern: "sessionStorage\\.setItem"
    - from: "src/services/geocodingService.ts"
      to: "sessionStorage"
      via: "read API key from sessionStorage"
      pattern: "sessionStorage\\.getItem"
---

<objective>
Create opt-in accurate geocoding with user consent modal and user-provided API key.

Purpose: Allow users to upgrade from postcode-centroid (~5km) to street-level accuracy, but only after explicit consent and with their own API key.
Output: AccurateGeocodingModal.tsx, updated geocodingService.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02.1-security-privacy-hardening/02.1-RESEARCH.md
@.planning/phases/02.1-security-privacy-hardening/02.1-03-SUMMARY.md
@.planning/phases/02.1-security-privacy-hardening/02.1-04-SUMMARY.md
@src/services/geocodingService.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update geocoding service for user-provided API key</name>
  <files>
    src/services/geocodingService.ts
  </files>
  <action>
Update `src/services/geocodingService.ts` to:
1. Remove environment variable API key usage
2. Add functions for API key management via sessionStorage
3. Require explicit API key parameter for batch geocoding

```typescript
/**
 * Geocoding service using Geoapify API
 * - Rate limited to 5 requests/second (free tier)
 * - Restricted to Germany (countrycode:de)
 * - API key provided by user at runtime (never bundled)
 */

// ... existing GeocodeResult and GeocodeProgress interfaces ...

const GEOAPIFY_ENDPOINT = 'https://api.geoapify.com/v1/geocode/search';
const RATE_LIMIT_DELAY_MS = 200;

// API key management - stored in sessionStorage (cleared on tab close)
export function getApiKey(): string | null {
  return sessionStorage.getItem('geoapify_api_key');
}

export function setApiKey(key: string): void {
  sessionStorage.setItem('geoapify_api_key', key);
}

export function clearApiKey(): void {
  sessionStorage.removeItem('geoapify_api_key');
}

export function hasApiKey(): boolean {
  return !!getApiKey();
}

// Update geocodeAddress to take apiKey parameter
async function geocodeAddress(
  address: string,
  apiKey: string
): Promise<GeocodeResult> {
  // ... existing implementation, using passed apiKey instead of env variable
}

// Update batchGeocode - API key now required parameter
export async function batchGeocode(
  addresses: string[],
  apiKey: string,  // Now required, not from env
  onProgress?: (progress: GeocodeProgress) => void
): Promise<GeocodeResult[]> {
  if (!apiKey) {
    return addresses.map((address) => ({
      address,
      status: 'failed' as const,
      error: 'No API key provided',
    }));
  }

  // ... rest of existing implementation
}

// Convenience wrapper that uses stored key
export async function batchGeocodeWithStoredKey(
  addresses: string[],
  onProgress?: (progress: GeocodeProgress) => void
): Promise<GeocodeResult[]> {
  const apiKey = getApiKey();
  if (!apiKey) {
    return addresses.map((address) => ({
      address,
      status: 'failed' as const,
      error: 'No API key stored. Please enable accurate geocoding first.',
    }));
  }
  return batchGeocode(addresses, apiKey, onProgress);
}
```

Remove any reference to `import.meta.env.VITE_GEOAPIFY_KEY`.
  </action>
  <verify>
    - `grep -v "VITE_GEOAPIFY" src/services/geocodingService.ts` shows no env variable usage
    - `grep "sessionStorage" src/services/geocodingService.ts` confirms session storage usage
    - `grep "getApiKey" src/services/geocodingService.ts` confirms export
    - `npm run build` succeeds
  </verify>
  <done>
    Geocoding service uses user-provided API key from sessionStorage, never from bundle
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AccurateGeocodingModal component</name>
  <files>
    src/components/AccurateGeocodingModal.tsx
  </files>
  <action>
Create `src/components/AccurateGeocodingModal.tsx` with GDPR-compliant consent UX:

```typescript
import { useState } from 'react';
import { setApiKey } from '../services/geocodingService';

interface AccurateGeocodingModalProps {
  pendingCount: number;  // Number of items that would be geocoded
  onConfirm: () => void;
  onCancel: () => void;
}

export function AccurateGeocodingModal({
  pendingCount,
  onConfirm,
  onCancel,
}: AccurateGeocodingModalProps) {
  const [apiKey, setApiKeyValue] = useState('');
  const [agreed, setAgreed] = useState(false);

  const handleConfirm = () => {
    if (apiKey && agreed) {
      setApiKey(apiKey);
      onConfirm();
    }
  };

  const canConfirm = apiKey.length > 0 && agreed;

  // Styles for GDPR-compliant equal button prominence
  const buttonBase = {
    padding: '12px 24px',
    borderRadius: '6px',
    fontSize: '16px',
    fontWeight: 500 as const,
    cursor: 'pointer',
    minWidth: '120px',
    border: 'none',
  };

  return (
    <div
      style={{
        position: 'fixed',
        inset: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        zIndex: 1000,
      }}
    >
      <div
        style={{
          backgroundColor: 'white',
          borderRadius: '12px',
          padding: '24px',
          maxWidth: '500px',
          width: '90%',
          boxShadow: '0 4px 20px rgba(0, 0, 0, 0.15)',
        }}
      >
        <h2 style={{ margin: '0 0 16px', fontSize: '20px' }}>
          Enable Accurate Geocoding
        </h2>

        <div
          style={{
            backgroundColor: '#fff3e0',
            border: '1px solid #ffcc80',
            borderRadius: '8px',
            padding: '16px',
            marginBottom: '16px',
          }}
        >
          <p style={{ margin: '0 0 8px', fontWeight: 500 }}>
            ⚠️ Privacy Notice
          </p>
          <p style={{ margin: '0 0 8px', fontSize: '14px' }}>
            This will send <strong>{pendingCount} street addresses</strong> to
            Geoapify's geocoding service to get precise coordinates.
          </p>
          <p style={{ margin: 0, fontSize: '14px', color: '#666' }}>
            Currently, distances use postcode centroids (~5km accuracy).
            Accurate mode provides street-level precision.
          </p>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label
            htmlFor="apiKey"
            style={{ display: 'block', marginBottom: '8px', fontWeight: 500 }}
          >
            Your Geoapify API Key:
          </label>
          <input
            id="apiKey"
            type="password"
            value={apiKey}
            onChange={(e) => setApiKeyValue(e.target.value)}
            placeholder="Enter your API key..."
            style={{
              width: '100%',
              padding: '10px 12px',
              borderRadius: '6px',
              border: '1px solid #ccc',
              fontSize: '14px',
              boxSizing: 'border-box',
            }}
          />
          <a
            href="https://www.geoapify.com/get-started-with-maps-api"
            target="_blank"
            rel="noopener noreferrer"
            style={{
              display: 'block',
              marginTop: '8px',
              fontSize: '13px',
              color: '#1976d2',
            }}
          >
            Get a free API key (3,000 requests/day)
          </a>
        </div>

        <div style={{ marginBottom: '20px' }}>
          <label
            style={{
              display: 'flex',
              alignItems: 'flex-start',
              gap: '10px',
              fontSize: '14px',
              cursor: 'pointer',
            }}
          >
            <input
              type="checkbox"
              checked={agreed}
              onChange={(e) => setAgreed(e.target.checked)}
              style={{ marginTop: '2px' }}
            />
            <span>
              I understand that address data will be sent to Geoapify and agree
              to their{' '}
              <a
                href="https://www.geoapify.com/terms-of-service"
                target="_blank"
                rel="noopener noreferrer"
              >
                Terms of Service
              </a>{' '}
              and{' '}
              <a
                href="https://www.geoapify.com/privacy-policy"
                target="_blank"
                rel="noopener noreferrer"
              >
                Privacy Policy
              </a>
            </span>
          </label>
        </div>

        {/* GDPR: Equal button prominence - same size, similar visual weight */}
        <div
          style={{
            display: 'flex',
            gap: '12px',
            justifyContent: 'flex-end',
          }}
        >
          <button
            onClick={onCancel}
            style={{
              ...buttonBase,
              backgroundColor: '#f0f0f0',
              color: '#333',
            }}
          >
            Cancel
          </button>
          <button
            onClick={handleConfirm}
            disabled={!canConfirm}
            style={{
              ...buttonBase,
              backgroundColor: canConfirm ? '#4a90d9' : '#ccc',
              color: 'white',
              cursor: canConfirm ? 'pointer' : 'not-allowed',
            }}
          >
            Geocode {pendingCount} addresses
          </button>
        </div>
      </div>
    </div>
  );
}
```

Key GDPR/UX requirements:
- Equal button prominence (same size, similar visual weight)
- Explicit consent checkbox with links to T&C and Privacy Policy
- Clear warning about data transfer
- API key is user-provided, never bundled
  </action>
  <verify>
    - File exists at src/components/AccurateGeocodingModal.tsx
    - `grep "Terms of Service" src/components/AccurateGeocodingModal.tsx` confirms T&C link
    - `grep "Privacy Policy" src/components/AccurateGeocodingModal.tsx` confirms privacy link
    - `npm run build` succeeds
  </verify>
  <done>
    Consent modal ready with GDPR-compliant UX, links to T&C, equal button prominence
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete security and privacy hardening:
- CSP meta tag (blocks external connections by default)
- Privacy badge in sidebar
- Clear data button in sidebar
- Encrypted localStorage for stores
- Bundled postcode data for local geocoding
- File size limits (5MB)
- Data count limits (1000 employees, 20 offices)
- Consent modal for accurate geocoding
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173 (or configured port)
3. Verify sidebar shows:
   - "All data stays in browser" privacy badge (green, with lock icon)
   - "Clear All Data" button (red/warning color)
4. Click "Clear All Data" - confirm dialog appears, after confirm page reloads with seed data
5. Check browser console - no CSP violation errors
6. Verify map loads correctly with OpenStreetMap tiles
7. Check localStorage in DevTools - values should be encrypted (not readable JSON)
8. Try importing CSV - should fail if >5MB or exceeds count limits
9. Verify seed data displays on map (employees at postcode centroids)
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues to address</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run dev` shows working app with all security features
3. Privacy badge visible in sidebar
4. Clear data button works
5. CSP in effect (no external fetch allowed except map tiles)
6. localStorage data encrypted
7. Consent modal properly styled with equal buttons
</verification>

<success_criteria>
- All 7 success criteria from ROADMAP.md met:
  1. Local geocoding (bundled postcode data)
  2. Encrypted localStorage
  3. Clear data button visible
  4. CSP headers in place
  5. Privacy badge displayed
  6. Accurate geocoding requires consent + user API key
  7. Data limits enforced
- User verification confirms visual and functional correctness
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-security-privacy-hardening/02.1-05-SUMMARY.md`
</output>
