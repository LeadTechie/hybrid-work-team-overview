---
phase: 02.1-security-privacy-hardening
plan: 03
subsystem: storage, types
tags: [zustand, encryption, typescript, zod, postcode]

# Dependency graph
requires:
  - phase: 02.1-01
    provides: encryptedStorage adapter with AES encryption
provides:
  - Encrypted localStorage for employee and office stores
  - Employee type with postcode, geocodeAccuracy field
  - Office type with postcode-based structure
  - Zod schemas requiring 5-digit German postcode
affects: [02.1-04-integration, phase-03-distance]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - createJSONStorage wrapper for custom Zustand storage adapters

key-files:
  created: []
  modified:
    - src/stores/employeeStore.ts
    - src/stores/officeStore.ts
    - src/types/employee.ts
    - src/types/office.ts
    - src/services/validationService.ts
    - src/services/encryptedStorage.ts

key-decisions:
  - "createJSONStorage for Zustand compatibility with encrypted storage"
  - "geocodeAccuracy tracks postcode-centroid vs address precision"
  - "Breaking type changes deferred to Plan 04 for migration"

patterns-established:
  - "Zustand storage adapters: use createJSONStorage with StateStorage implementation"
  - "Type evolution: change types first, fix dependent files in follow-up task"

# Metrics
duration: 2min
completed: 2026-02-07
---

# Phase 02.1 Plan 03: Store Encryption & Type Updates Summary

**Encrypted Zustand stores with postcode-based Employee/Office types and 5-digit German postcode validation**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-07T09:55:40Z
- **Completed:** 2026-02-07T09:57:40Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Employee and office stores now persist to encrypted localStorage
- Employee type supports postcode-centroid geocoding with accuracy tracking
- Office type updated to postcode-based structure
- Validation schemas enforce 5-digit German postcode format

## Task Commits

Each task was committed atomically:

1. **Task 1: Update stores to use encrypted storage** - `50ca81e` (feat)
2. **Task 2: Update types and validation for postcode-based geocoding** - `8efbc78` (feat)

## Files Created/Modified
- `src/stores/employeeStore.ts` - Uses encryptedStorage adapter for persist
- `src/stores/officeStore.ts` - Uses encryptedStorage adapter for persist
- `src/services/encryptedStorage.ts` - Fixed to use createJSONStorage for Zustand compatibility
- `src/types/employee.ts` - Added postcode, street, city, geocodeAccuracy fields
- `src/types/office.ts` - Added postcode, street, city fields (city now optional)
- `src/services/validationService.ts` - Schemas require 5-digit postcode, address removed

## Decisions Made
- **createJSONStorage wrapper:** The encryptedStorage class implementing StateStorage needed to be wrapped with createJSONStorage() for Zustand persist compatibility. Zustand's PersistStorage expects StorageValue objects, not raw strings.
- **geocodeAccuracy field:** Added to Employee type to track whether coordinates came from postcode centroid (~5km) or full address (precise). Enables UI differentiation and consent-based upgrades.
- **Breaking changes accepted:** Type changes break dependent files (seedEmployees, seedOffices, csvService, ImportPanel). These will be fixed in Plan 04 as planned.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed encryptedStorage Zustand type compatibility**
- **Found during:** Task 1 (Store encryption integration)
- **Issue:** EncryptedStorage class returns string | null, but Zustand persist expects StorageValue<T> | null
- **Fix:** Changed encryptedStorage from class instance to createJSONStorage() wrapper around StateStorage object
- **Files modified:** src/services/encryptedStorage.ts
- **Verification:** npm run build succeeds for store files
- **Committed in:** 50ca81e (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Essential fix for Zustand compatibility. No scope creep.

## Issues Encountered
- Build fails on dependent files (seedEmployees.ts, seedOffices.ts, csvService.ts, ImportPanel.tsx) due to address->postcode type change. This is expected and documented in the plan as "to be fixed in Plan 04".

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Encrypted storage foundation complete
- Type definitions ready for postcode-based geocoding
- Plan 04 must update all dependent files to use new type structure:
  - seedEmployees.ts - generate postcode instead of address
  - seedOffices.ts - use postcode format with pre-geocoded coords
  - csvService.ts - parse postcode column from CSV
  - ImportPanel.tsx - display postcode in validation errors
- After Plan 04, build should pass with full postcode-based geocoding

---
*Phase: 02.1-security-privacy-hardening*
*Completed: 2026-02-07*

## Self-Check: PASSED
