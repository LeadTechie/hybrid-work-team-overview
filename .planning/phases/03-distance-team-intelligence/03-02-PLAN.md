---
phase: 03-distance-team-intelligence
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/filters/FilterPanel.tsx
  - src/components/map/EmployeeMarker.tsx
  - src/components/map/DistanceLines.tsx
  - src/components/tables/EmployeesTable.tsx
autonomous: false

must_haves:
  truths:
    - "User sees a checkbox in FilterPanel to toggle between straight-line and estimated road distances"
    - "A ? button next to the checkbox opens the CircuityInfoModal explaining how estimation works"
    - "When checkbox is on, EmployeeMarker popup shows distances with ~ prefix and road-estimate formatting"
    - "When checkbox is on, DistanceLines tooltips show distances with ~ prefix and road-estimate formatting"
    - "When checkbox is on, EmployeesTable distance columns show distances with ~ prefix and road-estimate formatting"
    - "When checkbox is off, all distances display exactly as before (straight-line, no ~)"
  artifacts:
    - path: "src/components/filters/FilterPanel.tsx"
      provides: "Circuity toggle checkbox with info button"
      contains: "useRoadDistance"
    - path: "src/components/map/EmployeeMarker.tsx"
      provides: "Conditionally formatted distances in popup"
      contains: "useRoadDistance"
    - path: "src/components/map/DistanceLines.tsx"
      provides: "Conditionally formatted distance tooltips"
      contains: "useRoadDistance"
    - path: "src/components/tables/EmployeesTable.tsx"
      provides: "Conditionally formatted distance columns"
      contains: "useRoadDistance"
  key_links:
    - from: "src/components/filters/FilterPanel.tsx"
      to: "src/stores/filterStore.ts"
      via: "useRoadDistance toggle"
      pattern: "setUseRoadDistance"
    - from: "src/components/filters/FilterPanel.tsx"
      to: "src/components/CircuityInfoModal.tsx"
      via: "? button opens modal"
      pattern: "CircuityInfoModal"
    - from: "src/components/map/EmployeeMarker.tsx"
      to: "src/utils/distance.ts"
      via: "formatDistance with useRoadEstimate flag"
      pattern: "formatDistance.*useRoadDistance"
    - from: "src/components/map/DistanceLines.tsx"
      to: "src/utils/distance.ts"
      via: "formatDistance with useRoadEstimate flag"
      pattern: "formatDistance.*useRoadDistance"
    - from: "src/components/tables/EmployeesTable.tsx"
      to: "src/utils/distance.ts"
      via: "formatDistance with useRoadEstimate flag"
      pattern: "formatDistance.*useRoadDistance"
---

<objective>
Wire the circuity toggle into the UI: add a checkbox with info button to FilterPanel, and update all 3 distance-displaying components to conditionally use road-estimate formatting based on the store toggle.

Purpose: Users can toggle between "as the crow flies" straight-line distances and circuity-adjusted road estimates, with an info modal explaining the methodology.
Output: Updated FilterPanel with checkbox + ? button, updated EmployeeMarker/DistanceLines/EmployeesTable to respect the toggle.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-distance-team-intelligence/03-01-SUMMARY.md
@src/components/filters/FilterPanel.tsx
@src/components/map/EmployeeMarker.tsx
@src/components/map/DistanceLines.tsx
@src/components/tables/EmployeesTable.tsx
@src/utils/distance.ts
@src/stores/filterStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add circuity checkbox and info button to FilterPanel</name>
  <files>src/components/filters/FilterPanel.tsx</files>
  <action>
Add a third checkbox in the "map-mode-toggle" section of FilterPanel, below the existing "Don't group people" checkbox. Also add an info modal trigger.

1. **Import** `CircuityInfoModal` from `../CircuityInfoModal` and `useState` (already imported via useMemo, add useState).

2. **Add state:** `const [showCircuityInfo, setShowCircuityInfo] = useState(false);`

3. **Read store values:**
   - `const useRoadDistance = useFilterStore((s) => s.useRoadDistance);`

4. **Add new checkbox div** after the "Don't group people" div, using the same `map-mode-toggle` className:
   ```jsx
   <div className="map-mode-toggle">
     <label>
       <input
         type="checkbox"
         checked={useRoadDistance}
         onChange={(e) =>
           useFilterStore.getState().setUseRoadDistance(e.target.checked)
         }
       />
       Est. road distances
     </label>
     <button
       type="button"
       onClick={() => setShowCircuityInfo(true)}
       style={{
         background: 'none',
         border: '1px solid #d1d5db',
         borderRadius: '50%',
         width: '20px',
         height: '20px',
         fontSize: '12px',
         cursor: 'pointer',
         color: '#6b7280',
         display: 'inline-flex',
         alignItems: 'center',
         justifyContent: 'center',
         marginLeft: '6px',
         padding: 0,
         lineHeight: 1,
         flexShrink: 0,
       }}
       title="How road distance estimation works"
       aria-label="How road distance estimation works"
     >
       ?
     </button>
   </div>
   ```

5. **Render modal** just before the closing `</div>` of filter-panel:
   ```jsx
   {showCircuityInfo && (
     <CircuityInfoModal onClose={() => setShowCircuityInfo(false)} />
   )}
   ```

The checkbox label says "Est. road distances" — short enough for the sidebar, with the ? button providing detailed explanation.
  </action>
  <verify>
Run: `npx tsc --noEmit` — no type errors.
Visual check: FilterPanel renders 3 checkboxes in map settings section, ? button appears next to third checkbox.
  </verify>
  <done>
FilterPanel has a third checkbox "Est. road distances" with a circular ? button that opens CircuityInfoModal. Checkbox toggles useRoadDistance in filterStore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update EmployeeMarker, DistanceLines, and EmployeesTable to use circuity toggle</name>
  <files>src/components/map/EmployeeMarker.tsx, src/components/map/DistanceLines.tsx, src/components/tables/EmployeesTable.tsx</files>
  <action>
All three files currently call `formatDistance(distance)`. Update them to pass the `useRoadDistance` flag from the store.

**EmployeeMarker.tsx:**
1. Add store read: `const useRoadDistance = useFilterStore((s) => s.useRoadDistance);`
   (useFilterStore is already imported)
2. In the popup distance display, change:
   `{formatDistance(distance)}` => `{formatDistance(distance, useRoadDistance)}`
   This is on the line inside `officeDistances.map(({ office, distance }) => ...)`.
3. Also update the header label conditionally:
   - Current: `"Distances to offices:"`
   - When useRoadDistance: `"Est. road distances:"` / when not: `"Distances to offices:"`
   Use a ternary: `{useRoadDistance ? 'Est. road distances:' : 'Distances to offices:'}`

**DistanceLines.tsx:**
1. Import `useFilterStore` from `../../stores/filterStore`.
2. Add store read at component top: `const useRoadDistance = useFilterStore((s) => s.useRoadDistance);`
3. Change tooltip content:
   `{formatDistance(dist)} to {office.name}` => `{formatDistance(dist, useRoadDistance)} to {office.name}`

**EmployeesTable.tsx:**
1. Read the store value. useFilterStore is already imported. Add:
   `const useRoadDistance = useFilterStore((s) => s.useRoadDistance);`
   Place this inside the EmployeesTable component, alongside the other useFilterStore calls.
2. In the office distance column render function, change:
   `return formatDistance(distance);` => `return formatDistance(distance, useRoadDistance);`
3. Update the column label to indicate estimation mode. Change the office column label:
   - Current: `` `-> ${office.name}` ``
   - When useRoadDistance: `` `~> ${office.name}` `` (tilde-arrow instead of arrow)
   - Use a ternary or conditional string.

NOTE: The `columns` useMemo dependency array must include `useRoadDistance` since column labels change. Add it: `[offices, useRoadDistance]`.
Also: The `displayEmployees` useMemo does NOT need to change — it still stores raw haversine values. The formatting happens at render time in the column render function.
  </action>
  <verify>
1. `npx tsc --noEmit` passes.
2. Run the dev server: `npm run dev`
3. Manual verification:
   - Click an employee on the map — popup shows straight-line distances (e.g. "50.0 km")
   - Toggle "Est. road distances" checkbox — popup distances change to road estimates (e.g. "~70 km")
   - Distance lines tooltips also update
   - Employees table distance columns also update
   - Toggle off — everything reverts to straight-line format
   - The ? button opens the info modal, "Got it" closes it
  </verify>
  <done>
All 3 distance consumers (EmployeeMarker popup, DistanceLines tooltip, EmployeesTable columns) conditionally format distances based on useRoadDistance toggle. Labels update to indicate estimation mode.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Circuity factor toggle feature: checkbox in FilterPanel toggles between straight-line and estimated road distances across all distance displays (map popups, distance lines, employee table).
  </what-built>
  <how-to-verify>
  1. Open the app (npm run dev)
  2. Click any employee marker — verify popup shows "Distances to offices:" with values like "50.0 km"
  3. In the sidebar, find the "Est. road distances" checkbox (below "Don't group people")
  4. Click the ? button next to it — verify info modal opens with explanation of circuity factors, accuracy info, and example
  5. Click "Got it" to close the modal
  6. Check the "Est. road distances" checkbox
  7. Click the same employee — verify popup now shows "Est. road distances:" with values like "~70 km"
  8. Verify the distance lines on the map also show ~ prefixed values
  9. Switch to "Employees" tab — verify distance columns show ~> headers and ~ prefixed values
  10. Uncheck the checkbox — verify everything reverts to straight-line format
  11. Click "Clear Filters" — verify the checkbox state is NOT cleared (visual preference persists)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. Checkbox toggles road distance estimation on/off
4. ? button opens info modal with explanation
5. All 3 distance consumers respect the toggle
6. Backward compatible: checkbox OFF = exact same behavior as before
7. clearFilters does NOT reset the checkbox
</verification>

<success_criteria>
- FilterPanel has "Est. road distances" checkbox with ? info button
- CircuityInfoModal explains circuity factors with accuracy examples
- EmployeeMarker popup, DistanceLines tooltip, and EmployeesTable columns all conditionally format distances
- Toggle OFF = exact same output as before (no regression)
- Toggle ON = ~ prefixed road estimates with appropriate rounding
- clearFilters preserves checkbox state
</success_criteria>

<output>
After completion, create `.planning/phases/03-distance-team-intelligence/03-02-SUMMARY.md`
</output>
