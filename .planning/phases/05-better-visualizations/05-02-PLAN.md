---
phase: 05-better-visualizations
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/map/MapView.tsx
  - src/components/map/EmployeeMarker.tsx
  - src/components/map/DistanceLines.tsx
  - src/components/filters/FilterPanel.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle map to B&W/faded mode via checkbox in sidebar"
    - "Clicking an employee draws dashed lines to all offices with distance labels"
    - "Clicking the same employee again deselects them and removes distance lines"
    - "Employee popup includes Google Maps navigation link to their assigned office"
    - "Selected employee marker pulses with blue glow, visually distinct from others"
  artifacts:
    - path: "src/components/map/DistanceLines.tsx"
      provides: "Polyline distance visualization from selected employee to all offices"
      exports: ["DistanceLines"]
    - path: "src/components/map/MapView.tsx"
      provides: "Grayscale TileLayer toggle and DistanceLines integration"
      contains: "DistanceLines"
    - path: "src/components/map/EmployeeMarker.tsx"
      provides: "Click-to-select handler and Google Maps popup link"
      contains: "buildGoogleMapsDirectionsUrl"
    - path: "src/components/filters/FilterPanel.tsx"
      provides: "B&W map mode toggle checkbox"
      contains: "mapMode"
  key_links:
    - from: "src/components/filters/FilterPanel.tsx"
      to: "src/stores/filterStore.ts"
      via: "mapMode state toggle"
      pattern: "setMapMode"
    - from: "src/components/map/MapView.tsx"
      to: "src/components/map/DistanceLines.tsx"
      via: "renders DistanceLines when employee selected"
      pattern: "<DistanceLines"
    - from: "src/components/map/EmployeeMarker.tsx"
      to: "src/utils/googleMapsUrl.ts"
      via: "popup link to Google Maps"
      pattern: "buildGoogleMapsDirectionsUrl"
    - from: "src/components/map/EmployeeMarker.tsx"
      to: "src/stores/filterStore.ts"
      via: "click handler sets selectedEmployeeId"
      pattern: "setSelectedEmployeeId"
---

<objective>
Wire all Phase 5 visualization features into the UI components: grayscale map toggle, distance lines on employee click, Google Maps links in popups, and selected marker visual enhancement.

Purpose: Deliver the four user-facing visualization enhancements using the foundations from Plan 01.
Output: Fully working B&W toggle, distance lines, Google Maps links, and pulsing selected markers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-better-visualizations/05-RESEARCH.md
@.planning/phases/05-better-visualizations/05-01-SUMMARY.md

@src/components/map/MapView.tsx
@src/components/map/EmployeeMarker.tsx
@src/components/filters/FilterPanel.tsx
@src/stores/filterStore.ts
@src/utils/googleMapsUrl.ts
@src/utils/distance.ts
@src/utils/markerIcons.ts
@src/types/employee.ts
@src/types/office.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DistanceLines component and wire MapView with grayscale toggle</name>
  <files>src/components/map/DistanceLines.tsx, src/components/map/MapView.tsx</files>
  <action>
1. Create `src/components/map/DistanceLines.tsx`:
   - Import Polyline, Tooltip from 'react-leaflet'
   - Import calculateDistance, formatDistance from '../../utils/distance'
   - Import Employee type from '../../types/employee'
   - Import Office type from '../../types/office'
   - Props: `{ employee: Employee; offices: Office[] }`
   - Guard: if employee has no coords, return null
   - For each office with valid coords:
     - Calculate distance using calculateDistance(employee.coords.lat, employee.coords.lon, office.coords.lat, office.coords.lon)
     - Create positions array: [[employee.coords.lat, employee.coords.lon], [office.coords.lat, office.coords.lon]]
     - Render `<Polyline>` with pathOptions: `{ color: '#3b82f6', weight: 2, dashArray: '8 4', opacity: 0.8 }`
     - Inside Polyline, render `<Tooltip permanent direction="center" className="distance-tooltip">`
     - Tooltip content: `{formatDistance(dist)} to {office.name}`
   - Export named: `export function DistanceLines({ employee, offices }: DistanceLinesProps)`

2. Modify `src/components/map/MapView.tsx`:
   - Import useFilterStore's mapMode (add to destructuring of existing useFilterStore call)
   - Import DistanceLines from './DistanceLines'
   - Compute tileClassName: `const tileClassName = mapMode === 'grayscale' ? 'map-tiles-grayscale' : '';`
   - Add `key={tileClassName}` and `className={tileClassName}` to existing TileLayer
   - After MapController, add DistanceLines rendering:
     ```
     {selectedEmployee && selectedEmployee.coords && (
       <DistanceLines employee={selectedEmployee} offices={geocodedOffices} />
     )}
     ```
   - Place DistanceLines OUTSIDE the MarkerClusterGroup (it's a map overlay, not a clustered marker)
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Run `npm run build` -- builds successfully. Verify DistanceLines.tsx exports DistanceLines component. Verify MapView renders DistanceLines conditionally and TileLayer has key prop.
  </verify>
  <done>DistanceLines component renders polylines from selected employee to all offices with distance labels. MapView applies grayscale CSS class to TileLayer based on mapMode, with key prop for re-mount.</done>
</task>

<task type="auto">
  <name>Task 2: Add click-to-select and Google Maps links to EmployeeMarker, add B&W toggle to FilterPanel</name>
  <files>src/components/map/EmployeeMarker.tsx, src/components/filters/FilterPanel.tsx</files>
  <action>
1. Modify `src/components/map/EmployeeMarker.tsx`:
   - Import useFilterStore from '../../stores/filterStore'
   - Import buildGoogleMapsDirectionsUrl from '../../utils/googleMapsUrl'
   - Import useOfficeStore from '../../stores/officeStore'
   - Add click handler to Marker's eventHandlers prop:
     ```
     eventHandlers={{
       click: () => {
         const store = useFilterStore.getState();
         store.setSelectedEmployeeId(
           store.selectedEmployeeId === employee.id ? null : employee.id
         );
       },
     }}
     ```
   - Enhance Popup content:
     - Keep existing name, team, department display
     - Add assigned office display if employee.assignedOffice exists
     - Find the assigned office from officeStore to get its coords
     - If assigned office has coords AND employee has coords, add Google Maps link:
       ```
       <a
         href={buildGoogleMapsDirectionsUrl(employee.coords, officeCoords)}
         target="_blank"
         rel="noopener noreferrer"
         style={{ color: '#3b82f6', textDecoration: 'none', fontSize: '12px' }}
       >
         Navigate to {employee.assignedOffice}
       </a>
       ```
     - Access offices via `useOfficeStore.getState().offices` inside the component (not via hook since it's memo'd -- use getState to avoid unnecessary re-renders, or access offices via the hook and add to memo comparison)
     - PREFERRED approach: Add `offices` as a prop passed from MapView, to keep EmployeeMarker pure. OR use `useMemo` with `useOfficeStore` selector. Choose whichever is simpler -- the research recommends keeping the component focused. Use `useOfficeStore` hook with a selector for just the offices array.
   - Update React.memo comparison: Since we're adding the store hook, the memo still works -- hooks inside the component only trigger re-render when their selected state changes. The offices array changes rarely.

2. Modify `src/components/filters/FilterPanel.tsx`:
   - Import mapMode and setMapMode from useFilterStore (add to existing destructuring)
   - After the "Clear Filters" button, add a B&W map toggle section:
     ```
     <div className="map-mode-toggle">
       <label>
         <input
           type="checkbox"
           checked={mapMode === 'grayscale'}
           onChange={(e) => setMapMode(e.target.checked ? 'grayscale' : 'normal')}
         />
         B&W map mode
       </label>
     </div>
     ```
   - Place it after the clear button, separated as a "Map Settings" section
  </action>
  <verify>
Run `npx tsc --noEmit` -- no TypeScript errors. Run `npm run build` -- builds successfully. Verify EmployeeMarker has click handler and Google Maps link in popup. Verify FilterPanel has B&W toggle checkbox.
  </verify>
  <done>Clicking employee markers toggles selection. Employee popup shows Google Maps navigation link to assigned office. FilterPanel has B&W map mode checkbox toggle.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
All four Phase 5 visualization features:
1. B&W/grayscale map toggle via checkbox in sidebar
2. Distance lines from selected employee to all offices with distance labels
3. Google Maps navigation links in employee popup
4. Pulsing glow animation on selected employee marker
  </what-built>
  <how-to-verify>
1. Open the app at http://localhost:5173
2. **B&W Toggle:** In the sidebar filter panel, check the "B&W map mode" checkbox. Map tiles should turn grayscale with slight brightness boost. Uncheck to return to color.
3. **Click-to-Select:** Click any employee marker on the map. It should:
   - Pulse with a blue glow animation
   - Draw dashed blue lines to all 5 office locations
   - Show distance labels (e.g., "42.3 km to Frankfurt") at the midpoint of each line
4. **Deselect:** Click the same employee marker again. Lines and pulse should disappear.
5. **Google Maps Link:** Click an employee marker, then click the popup that appears. If the employee has an assigned office, you should see a "Navigate to [Office Name]" link. Click it -- should open Google Maps in a new tab with directions from employee location to office.
6. **B&W + Lines Together:** Enable B&W mode, then select an employee. The blue distance lines should stand out clearly against the grayscale map.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. B&W toggle in sidebar changes map appearance
4. Clicking employee shows distance lines to all offices
5. Distance labels display correct km values
6. Google Maps links open in new tab with correct origin/destination
7. Selected marker has visible pulse animation
8. Deselecting removes all visual enhancements
</verification>

<success_criteria>
- All four VIS requirements implemented and visually verified
- No TypeScript errors, build succeeds
- No new npm dependencies added
- No CSP changes needed (navigation links are not blocked by connect-src)
- Existing functionality (filtering, search, clustering) unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/05-better-visualizations/05-02-SUMMARY.md`
</output>
